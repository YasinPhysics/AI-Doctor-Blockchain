<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ - ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #009688;
      --primary-dark: #00796b;
      --accent: #ff5722;
      --bg: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      --card: white;
      --text: #004d40;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: #333;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: var(--primary-dark);
      margin-bottom: 20px;
    }

    #chat-container {
      max-width: 760px;
      margin: 0 auto 30px;
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      overflow: hidden;
    }

    #chat-header {
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 18px;
      text-align: center;
      font-weight: 600;
      font-size: 1.35rem;
    }

    #chat-body {
      height: 460px;
      overflow-y: auto;
      padding: 24px;
      background: #f8f9fa;
    }

    .message {
      margin: 16px 0;
      padding: 14px 20px;
      border-radius: 22px;
      max-width: 84%;
      line-height: 1.55;
      word-wrap: break-word;
      font-size: 1.02rem;
    }

    .user {
      background: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 6px;
    }

    .bot {
      background: #e0f2f1;
      color: var(--text);
      margin-right: auto;
      border-bottom-left-radius: 6px;
    }

    #input-area {
      display: flex;
      padding: 16px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
    }

    #userInput {
      flex: 1;
      padding: 14px 20px;
      border: 1px solid #ccc;
      border-radius: 50px;
      outline: none;
      font-size: 1.05rem;
    }

    #userInput:focus {
      border-color: var(--primary);
    }

    #sendBtn {
      margin-left: 12px;
      padding: 0 28px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
    }

    .auth-buttons {
      text-align: center;
      margin: 24px 0;
    }

    #connectBtn, #logoutBtn {
      padding: 14px 40px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 10px;
    }

    #connectBtn {
      background: var(--accent);
      color: white;
    }

    #logoutBtn {
      background: #e74c3c;
      color: white;
      display: none;
    }

    #status {
      text-align: center;
      margin: 16px 0;
      color: #555;
      font-weight: 500;
    }

    canvas {
      margin: 30px auto;
      display: block;
      max-width: 100%;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <h1>AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ - ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</h1>

  <div id="chat-container">
    <div id="chat-header">Arc Testnet - LifeHealth Chain</div>
    <div id="chat-body">
      <div class="message bot">
        ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üëã ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡•§<br><br>
        ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶‡ßá ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶¨‡•§<br>
        ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶¨‡•§<br><br>
        ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ø‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã:<br>
        ‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br>
        ‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã
      </div>
    </div>

    <div id="input-area">
      <input type="text" id="userInput" placeholder="‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶¨‡¶≤‡ßã ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì..." autocomplete="off" />
      <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
  </div>

  <div class="auth-buttons">
    <button id="connectBtn">‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Arc Testnet)</button>
    <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
  </div>

  <div id="status">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶®‡¶Ø‡¶º</div>

  <canvas id="recordChart" width="600" height="300"></canvas>

  <script>
    const CONTRACT_ADDRESS = "0x1cA1699c69852Eb81D4eb68Da33ac61D064f7Be1";

    let provider, signer, userAddress;
    let fixedStep = -1, updateStep = -1, recordStep = -1;
    let profile = {}, record = {};
    let chart = null;

    // ‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ‚Äî ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
    let medicinesList = [];          // ‡¶∏‡¶¨ ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶¨‡ßá
    let askingMedicine = false;      // ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶≤‡ßÅ‡¶™ ‡¶ö‡¶≤‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ
    let currentMedicine = {};        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø

    function msg(text, user = false) {
      const div = document.createElement("div");
      div.className = `message ${user ? "user" : "bot"}`;
      div.innerHTML = text;
      document.getElementById("chat-body").appendChild(div);
      div.scrollIntoView({ behavior: "smooth" });
    }

    async function connect() {
      if (!window.ethereum) return msg("MetaMask ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßã‡•§");

      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        const net = await provider.getNetwork();
        if (Number(net.chainId) !== 5042002) return msg("Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßã‡•§");

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("userInput").disabled = false;

        msg(`‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (${userAddress.slice(0,6)}...${userAddress.slice(-4)})`);
        await checkProfile();
      } catch (e) {
        msg("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (e.message || "Unknown"));
      }
    }

    document.getElementById("connectBtn").onclick = connect;
    document.getElementById("logoutBtn").onclick = () => location.reload();

    async function checkProfile() {
      try {
        const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        const fixed = await c.getFixedProfile(userAddress);

        if (fixed.dateOfBirth !== 0n) {
          msg("‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ, ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó ‡¶ì ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶õ‡ßá‡•§ ‡¶ñ‡ßÅ‡¶¨ ‡¶≠‡¶æ‡¶≤‡ßã! üåü");
          const p = await c.getPatientProfile(userAddress);

          if (p.weightKg > 0n && p.heightCm > 0n) {
            msg("‡¶ì‡¶ú‡¶® ‡¶ì ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ‡¶ì ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã‡•§<br>‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?");
          } else {
            msg("‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ì‡¶ú‡¶® ‡¶ì ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶è‡¶ñ‡¶®‡ßã ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§<br>‡¶ö‡¶≤‡ßã ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶á‡•§ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶ø?");
            updateStep = 0;
            askUpdate();
          }
        } else {
          msg("‡¶ö‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø‡•§<br>‡¶è‡¶ü‡¶æ ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶π‡¶¨‡ßá‡•§ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶¨?");
          fixedStep = 0;
          askFixed();
        }
      } catch {
        msg("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶ö‡¶≤‡ßã ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶∞‡¶ø‡•§");
        fixedStep = 0;
        askFixed();
      }
    }

    function askFixed() {
      const q = [
        "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡¶æ‡¶ì (DD-MM-YYYY ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá) üòä",
        "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó ‡¶ï‡ßÄ? (Male / Female / Other)",
        "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶ï‡ßÄ? (‡¶Ø‡ßá‡¶Æ‡¶®: A+, O-, AB-)"
      ];
      msg(q[fixedStep]);
    }

    function askUpdate() {
      const q = [
        "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ì‡¶ú‡¶® ‡¶ï‡¶§ ‡¶ï‡ßá‡¶ú‡¶ø? (‡¶Ø‡ßá‡¶Æ‡¶®: 68)",
        "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶ï‡¶§ ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞? (‡¶Ø‡ßá‡¶Æ‡¶®: 170)",
        "‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ú‡¶ø ‡¶Ü‡¶õ‡ßá? (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ø‡¶ñ‡ßã, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip ‡¶≤‡¶ø‡¶ñ‡ßã)",
        "‡¶ï‡ßã‡¶®‡ßã ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡¶ø ‡¶∞‡ßã‡¶ó ‡¶Ü‡¶õ‡ßá? (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶°‡¶æ‡¶Ø‡¶º‡¶æ‡¶¨‡ßá‡¶ü‡¶ø‡¶∏, ‡¶â‡¶ö‡ßç‡¶ö ‡¶∞‡¶ï‡ßç‡¶§‡¶ö‡¶æ‡¶™‡•§ ‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ø‡¶ñ‡ßã, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)"
      ];
      msg(q[updateStep]);
    }

    function askRecord() {
      if (recordStep === 0) {
        msg("‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶õ‡¶ø‡•§<br>‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
      } else if (recordStep === 1) {
        msg("‡¶ñ‡ßÅ‡¶¨ ‡¶≠‡¶æ‡¶≤‡ßã‡•§ ‡¶è‡¶ñ‡¶® ‡¶è‡¶á ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶¨‡¶æ ‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 180 mg/dL ‡¶¨‡¶æ 140/90):");
      } else if (askingMedicine) {
        if (recordStep === 2) {
          msg("‡¶è‡¶á ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶ñ‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡¶®? ‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§<br>(‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶≤‡ßá '‡¶®‡¶æ‡¶á', 'skip' ‡¶¨‡¶æ 'done' ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)");
        } else if (recordStep === 3) {
          msg(`‡¶ì‡¶∑‡ßÅ‡¶ß: <b>${currentMedicine.name}</b><br>‡¶è‡¶ï‡¶¨‡¶æ‡¶∞‡ßá ‡¶ï‡¶§ ‡¶°‡ßã‡¶ú ‡¶ñ‡¶æ‡¶¨‡ßá‡¶®? (‡¶Ø‡ßá‡¶Æ‡¶®: 500mg, 1 ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡¶≤‡ßá‡¶ü)`);
        } else if (recordStep === 4) {
          msg("‡¶¶‡¶ø‡¶®‡ßá ‡¶ï‡¶§‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶ï‡¶ñ‡¶® ‡¶ñ‡¶æ‡¶¨‡ßá‡¶®? (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¶‡¶ø‡¶®‡ßá ‡ß® ‡¶¨‡¶æ‡¶∞, ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßÆ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ ‡¶™‡¶∞)");
        } else if (recordStep === 5) {
          msg("‡¶Æ‡ßã‡¶ü ‡¶ï‡¶§‡¶¶‡¶ø‡¶® ‡¶è‡¶á ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶ñ‡¶æ‡¶¨‡ßá‡¶®? (‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)");
        }
      } else if (recordStep === 6) {
        msg("‡¶∞‡ßã‡¶ó ‡¶¨‡¶æ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∞‡¶ì ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶ö‡¶æ‡¶®? (‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶®‡ßã‡¶ü, ‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤ ‚Äî ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)");
      } else if (recordStep === 7) {
        msg("‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¨‡¶æ ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ IPFS CID ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¶‡¶ø‡¶® (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤ ‚Äî ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)");
      }
    }

    document.getElementById("sendBtn").onclick = async () => {
      const input = document.getElementById("userInput");
      const txt = input.value.trim();
      if (!txt) return;
      msg(txt, true);
      input.value = "";

      if (!signer) return msg("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã‡•§");

      const low = txt.toLowerCase();

      // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤
      if (fixedStep >= 0) {
        if (["skip","‡¶®‡¶æ‡¶á",""].includes(low)) return msg("‡¶è‡¶ü‡¶æ ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ø‡¶ñ‡ßã‡•§");
        if (fixedStep === 0) {
          const [d,m,y] = txt.split("-");
          profile.dob = Math.floor(new Date(y, m-1, d).getTime()/1000);
        } else if (fixedStep === 1) profile.gender = txt;
        else profile.blood = txt;

        fixedStep++;
        if (fixedStep === 3) {
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          const tx = await c.setFixedProfile(profile.dob, profile.gender, profile.blood);
          msg(`‡¶∏‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
          await tx.wait();
          msg("‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶! ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡•§ üåü");
          fixedStep = -1;
          checkProfile();
        } else askFixed();
        return;
      }

      // ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶¨‡¶≤ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤
      if (updateStep >= 0) {
        const skip = ["skip","‡¶®‡¶æ‡¶á",""].includes(low);
        if (skip && updateStep < 2) return msg("‡¶ì‡¶ú‡¶® ‡¶Ü‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ üòä");

        if (updateStep === 0) profile.weight = parseInt(txt) || 0;
        else if (updateStep === 1) profile.height = parseInt(txt) || 0;
        else if (updateStep === 2) profile.allergies = skip ? [] : txt.split(",").map(s=>s.trim()).filter(Boolean);
        else profile.chronic = skip ? [] : txt.split(",").map(s=>s.trim()).filter(Boolean);

        updateStep++;
        if (updateStep === 4) {
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          const tx = await c.updateProfile(profile.weight, profile.height, profile.allergies, profile.chronic);
          msg(`‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
          await tx.wait();
          msg("‡¶ñ‡ßÅ‡¶¨ ‡¶≠‡¶æ‡¶≤‡ßã! ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã‡•§");
          updateStep = -1;
        } else askUpdate();
        return;
      }

      // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó (‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡ßÅ‡¶™ ‡¶∏‡¶π)
      if (recordStep >= 0) {
        const skipped = ["skip", "‡¶®‡¶æ‡¶á", "done", "‡¶∂‡ßá‡¶∑", ""].includes(low);

        if (recordStep === 0) {
          record.disease = txt.trim() || "";
          recordStep = 1;
          askRecord();
          return;
        }

        if (recordStep === 1) {
          record.reading = txt.trim() || "";
          medicinesList = [];
          askingMedicine = true;
          recordStep = 2;
          msg("‡¶è‡¶ñ‡¶® ‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§ ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶ï ‡¶è‡¶ï ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§<br>‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø skip ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
          askRecord();
          return;
        }

        // ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶≤‡ßÅ‡¶™
        if (askingMedicine) {
          if (recordStep === 2) {
            if (skipped) {
              askingMedicine = false;
              recordStep = 6;
              msg("‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá, ‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶®‡ßá‡¶á ‡¶¨‡¶æ ‡¶∂‡ßá‡¶∑‡•§ ‡¶ö‡¶≤‡ßÅ‡¶® ‡¶™‡¶∞‡ßá‡¶∞ ‡¶ß‡¶æ‡¶™‡ßá ‡¶Ø‡¶æ‡¶á‡•§");
              askRecord();
            } else {
              currentMedicine.name = txt.trim();
              recordStep = 3;
              askRecord();
            }
            return;
          }

          if (recordStep === 3) {
            currentMedicine.dose = skipped ? "" : txt.trim();
            recordStep = 4;
            askRecord();
            return;
          }

          if (recordStep === 4) {
            currentMedicine.frequency = skipped ? "" : txt.trim();
            recordStep = 5;
            askRecord();
            return;
          }

          if (recordStep === 5) {
            const days = skipped ? 0 : (parseInt(txt) || 0);

            medicinesList.push([
              currentMedicine.name,
              currentMedicine.dose || "",
              currentMedicine.frequency || "",
              BigInt(days)
            ]);

            msg(`‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: <b>${currentMedicine.name}</b>`);

            addMessage("‡¶è‡¶á ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶∞‡¶ì ‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶Ü‡¶õ‡ßá? (‡¶π‡ßç‡¶Ø‡¶æ‡¶Å ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® ‡¶¨‡¶æ skip/‡¶®‡¶æ‡¶á/done ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)");
            recordStep = 2; // ‡¶≤‡ßÅ‡¶™ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶∞‡¶æ‡¶ñ‡¶æ
            return;
          }
        }

        // ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ß‡¶æ‡¶™
        if (recordStep === 6) {
          record.details = skipped ? "" : txt.trim();
          recordStep = 7;
          askRecord();
          return;
        }

        if (recordStep === 7) {
          record.ipfs = skipped ? "" : txt.trim();

          // ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ submit
          try {
            const selector = "0xcaf5bb2c";
            const coder = new ethers.AbiCoder();

            const encodedParams = coder.encode(
              ["string","string","tuple(string,string,string,uint256)[]","string","string"],
              [record.disease || "", record.reading || "", medicinesList, record.ipfs || "", record.details || ""]
            );

            const calldata = selector + encodedParams.slice(2);

            const tx = await signer.sendTransaction({
              to: CONTRACT_ADDRESS,
              data: calldata
            });

            msg(`‡¶Ø‡ßã‡¶ó ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            msg("‡¶π‡ßÅ‡¶∞‡¶∞‡ßá! üéâ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§<br>‡¶è‡¶ñ‡¶® '‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì' ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");

            // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
            recordStep = -1;
            askingMedicine = false;
            medicinesList = [];
            currentMedicine = {};
          } catch (e) {
            msg("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§<br>" + (e.reason || e.message || "Unknown error"));
            recordStep = -1;
            askingMedicine = false;
          }
          return;
        }
      }

      // ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°
      if (low.includes("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì") || low.includes("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø") || low.includes("record")) {
        try {
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          const recs = await c.getAllDiseaseRecords(userAddress);
          let txt = "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã:<br><br>";
          if (recs.length === 0) txt += "‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§ ‡¶ö‡¶≤‡ßã ‡¶è‡¶ï‡¶ü‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø!";
          else {
            recs.forEach(r => {
              txt += `<b>‡¶∞‡ßã‡¶ó:</b> ${r.diseaseName}<br>`;
              r.dailyRecords.forEach(d => {
                txt += `‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date(Number(d.timestamp)*1000).toLocaleString("bn-BD")}<br>`;
                txt += `‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç: ${d.readingValue}<br>`;
                txt += `‡¶ì‡¶ú‡¶®: ${d.patientWeightKg} kg, ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ: ${d.patientHeightCm} cm<br>`;
                if (d.medicines.length) {
                  txt += "<b>‡¶ì‡¶∑‡ßÅ‡¶ß:</b><br>";
                  d.medicines.forEach(m => txt += `‚Ä¢ ${m.name} (${m.dose}, ${m.frequency}, ${m.durationDays} ‡¶¶‡¶ø‡¶®)<br>`);
                }
                if (d.diseaseDetails) txt += `<b>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§:</b> ${d.diseaseDetails}<br>`;
                txt += "<br>";
              });
            });
          }
          msg(txt);
        } catch (e) {
          msg("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßã‡•§");
        }
        return;
      }

      if (low.includes("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°") || low.includes("‡¶Ø‡ßã‡¶ó") || low.includes("‡¶®‡¶§‡ßÅ‡¶®")) {
        recordStep = 0;
        record = {};
        medicinesList = [];
        askingMedicine = false;
        msg("‡¶ö‡¶Æ‡ßé‡¶ï‡¶æ‡¶∞! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡•§<br>‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶≤‡ßã‡•§ üòä");
        askRecord();
        return;
      }

      msg("‡¶π‡ßÅ‡¶Æ... ‡¶Ü‡¶Æ‡¶ø ‡¶†‡¶ø‡¶ï ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø‡•§<br>‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßã:<br>‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì<br>‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã<br>‚Ä¢ ‡¶π‡¶æ‡¶á / ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã");
    };

    document.getElementById("userInput").onkeypress = e => {
      if (e.key === "Enter") document.getElementById("sendBtn").click();
    };
  </script>
</body>
</html>
