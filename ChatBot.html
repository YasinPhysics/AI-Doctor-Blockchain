<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ - ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</title>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #009688;
      --primary-dark: #00796b;
      --accent: #ff5722;
      --bg-gradient: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      --card-bg: white;
      --text-dark: #004d40;
      --text-light: #333;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-light);
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: var(--primary-dark);
      margin: 0 0 20px;
      font-size: 2.2rem;
    }

    #chat-container {
      max-width: 760px;
      margin: 0 auto 30px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      overflow: hidden;
    }

    #chat-header {
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 18px;
      text-align: center;
      font-weight: 600;
      font-size: 1.35rem;
    }

    #chat-body {
      height: 460px;
      overflow-y: auto;
      padding: 24px;
      background: #f8f9fa;
    }

    .message {
      margin: 16px 0;
      padding: 14px 20px;
      border-radius: 22px;
      max-width: 84%;
      line-height: 1.55;
      word-wrap: break-word;
      font-size: 1.02rem;
    }

    .user {
      background: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 6px;
    }

    .bot {
      background: #e0f2f1;
      color: var(--text-dark);
      margin-right: auto;
      border-bottom-left-radius: 6px;
    }

    #input-area {
      display: flex;
      padding: 16px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
    }

    #userInput {
      flex: 1;
      padding: 14px 20px;
      border: 1px solid #ccc;
      border-radius: 50px;
      outline: none;
      font-size: 1.05rem;
      transition: border-color 0.2s;
    }

    #userInput:focus {
      border-color: var(--primary);
    }

    #sendBtn {
      margin-left: 12px;
      padding: 0 28px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    #sendBtn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .auth-buttons {
      text-align: center;
      margin: 24px 0;
    }

    #connectBtn, #logoutBtn {
      padding: 14px 40px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.2s;
      margin: 0 10px;
    }

    #connectBtn {
      background: var(--accent);
      color: white;
    }

    #connectBtn:hover {
      background: #e64a19;
    }

    #logoutBtn {
      background: #e74c3c;
      color: white;
      display: none;
    }

    #logoutBtn:hover {
      background: #c0392b;
    }

    #status {
      text-align: center;
      margin: 16px 0;
      color: #555;
      font-weight: 500;
    }

    canvas {
      margin: 30px auto;
      display: block;
      max-width: 100%;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    @media (max-width: 600px) {
      body { padding: 12px; }
      #chat-body { height: 380px; }
      h1 { font-size: 1.8rem; }
    }
  </style>
</head>
<body>

  <h1>AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ - ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</h1>

  <div id="chat-container">
    <div id="chat-header">Arc Testnet - LifeHealth Chain</div>
    <div id="chat-body">
      <div class="message bot">
        ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üëã ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§<br>
        ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶¨‡¶≤‡ßã ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì‡•§<br><br>
        ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:<br>
        ‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br>
        ‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã
      </div>
    </div>

    <div id="input-area">
      <input type="text" id="userInput" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." autocomplete="off" />
      <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
  </div>

  <div class="auth-buttons">
    <button id="connectBtn">‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Arc Testnet)</button>
    <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
  </div>

  <div id="status">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶®‡¶Ø‡¶º</div>

  <canvas id="recordChart" width="600" height="300"></canvas>

  <script>
    // ========================================
    //          ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
    // ========================================
    const CONTRACT_ADDRESS = "0x1cA1699c69852Eb81D4eb68Da33ac61D064f7Be1";
    const ARC_TESTNET_CHAIN_ID = 5042002;

    const ABI = [
      {"inputs":[{"internalType":"uint256","name":"_dateOfBirth","type":"uint256"},{"internalType":"string","name":"_gender","type":"string"},{"internalType":"string","name":"_bloodGroup","type":"string"}],"name":"setFixedProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"_weightKg","type":"uint256"},{"internalType":"uint256","name":"_heightCm","type":"uint256"},{"internalType":"string[]","name":"_allergies","type":"string[]"},{"internalType":"string[]","name":"_chronicDiseases","type":"string[]"}],"name":"updateProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"_diseaseName","type":"string"},{"internalType":"string","name":"_readingValue","type":"string"},{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"dose","type":"string"},{"internalType":"string","name":"frequency","type":"string"},{"internalType":"uint256","name":"durationDays","type":"uint256"}],"internalType":"struct LifeHealthChain.Medicine[]","name":"_medicines","type":"tuple[]"},{"internalType":"string","name":"_ipfsCid","type":"string"},{"internalType":"string","name":"_diseaseDetails","type":"string"}],"name":"addDailyRecord","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getAllDiseaseRecords","outputs":[{"components":[{"internalType":"string","name":"diseaseName","type":"string"},{"components":[{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"readingValue","type":"string"},{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"dose","type":"string"},{"internalType":"string","name":"frequency","type":"string"},{"internalType":"uint256","name":"durationDays","type":"uint256"}],"internalType":"struct LifeHealthChain.Medicine[]","name":"medicines","type":"tuple[]"},{"internalType":"string","name":"ipfsCid","type":"string"},{"internalType":"address","name":"addedBy","type":"address"},{"internalType":"uint256","name":"patientAgeAtRecord","type":"uint256"},{"internalType":"uint256","name":"patientWeightKg","type":"uint256"},{"internalType":"uint256","name":"patientHeightCm","type":"uint256"}],"internalType":"struct LifeHealthChain.DailyRecord[]","name":"dailyRecords","type":"tuple[]"}],"internalType":"struct LifeHealthChain.DiseaseRecord[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getPatientProfile","outputs":[{"components":[{"internalType":"uint256","name":"weightKg","type":"uint256"},{"internalType":"uint256","name":"heightCm","type":"uint256"},{"internalType":"string[]","name":"allergies","type":"string[]"},{"internalType":"string[]","name":"chronicDiseases","type":"string[]"},{"internalType":"address[]","name":"allowedDoctors","type":"address[]"}],"internalType":"struct LifeHealthChain.PatientProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getFixedProfile","outputs":[{"internalType":"uint256","name":"dateOfBirth","type":"uint256"},{"internalType":"string","name":"gender","type":"string"},{"internalType":"string","name":"bloodGroup","type":"string"}],"stateMutability":"view","type":"function"}
    ];

    // ========================================
    //          ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤
    // ========================================
    let provider = null;
    let signer = null;
    let userAddress = null;
    let chartInstance = null;

    // Setup states
    let fixedProfileStep = -1;
    let updatableProfileStep = -1;
    let recordStep = -1;

    let profileData = {};
    let recordData = {};

    // ========================================
    //          UI ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    // ========================================
    function addMessage(text, isUser = false) {
      const chatBody = document.getElementById("chat-body");
      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${isUser ? "user" : "bot"}`;
      msgDiv.innerHTML = text;  // HTML allowed for better formatting
      chatBody.appendChild(msgDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function updateStatus(text) {
      document.getElementById("status").textContent = `‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ${text}`;
    }

    // ========================================
    //          ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶®
    // ========================================
    async function connectWallet() {
      if (!window.ethereum) {
        updateStatus("‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø");
        addMessage("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá MetaMask ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø Ethereum ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      try {
        updateStatus("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        if (Number(network.chainId) !== 5042002) {
          updateStatus("Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶® (Chain ID: 5042002)");
          addMessage("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá MetaMask-‡¶è Arc Testnet ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï‡ßá ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
          return;
        }

        updateStatus(`‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`);
        addMessage("‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®:<br>‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br>‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°");

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("userInput").disabled = false;

        await checkProfiles();
      } catch (err) {
        updateStatus("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ");
        addMessage("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown error"));
      }
    }

    function disconnectWallet() {
      provider = signer = userAddress = null;
      fixedProfileStep = updatableProfileStep = recordStep = -1;
      updateStatus("‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶®‡¶Ø‡¶º");
      document.getElementById("connectBtn").style.display = "inline-block";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("sendBtn").disabled = true;
      document.getElementById("userInput").disabled = true;
      addMessage("‡¶Ü‡¶™‡¶®‡¶ø ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");

      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
    }

    // ========================================
    //          ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ì ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
    // ========================================
    async function checkProfiles() {
      try {
        const fixed = await new ethers.Contract(CONTRACT_ADDRESS, ABI, signer).getFixedProfile(userAddress);
        if (fixed.dateOfBirth !== 0n) {
          addMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§");
          fixedProfileStep = -1;

          const profile = await new ethers.Contract(CONTRACT_ADDRESS, ABI, signer).getPatientProfile(userAddress);
          if (profile.weightKg > 0n && profile.heightCm > 0n) {
            addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßá‡¶ü‡•§ ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
          } else {
            addMessage("‡¶ì‡¶ú‡¶®, ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶ö‡¶≤‡ßÅ‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø‡•§");
            updatableProfileStep = 0;
            askUpdatableProfile();
          }
        } else {
          addMessage("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá (‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ, ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó, ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™)‡•§");
          fixedProfileStep = 0;
          askFixedProfile();
        }
      } catch (err) {
        addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶ö‡¶≤‡ßÅ‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶ø‡•§");
        fixedProfileStep = 0;
        askFixedProfile();
      }
    }

    // ========================================
    //          ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
    // ========================================
    function askFixedProfile() {
      const questions = [
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (DD-MM-YYYY ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (Male / Female / Other)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: A+, O-, B- ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø)"
      ];
      addMessage(questions[fixedProfileStep]);
    }

    // ========================================
    //          ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶¨‡¶≤ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
    // ========================================
    function askUpdatableProfile() {
      const questions = [
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ì‡¶ú‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡ßá‡¶ú‡¶ø‡¶§‡ßá)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ú‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)",
        "‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡¶ø ‡¶∞‡ßã‡¶ó ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)"
      ];
      addMessage(questions[updatableProfileStep]);
    }

    // ========================================
    //          ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
    // ========================================
    function askRecord() {
      const questions = [
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶°‡¶æ‡¶Ø‡¶º‡¶æ‡¶¨‡ßá‡¶ü‡¶ø‡¶∏, ‡¶â‡¶ö‡ßç‡¶ö ‡¶∞‡¶ï‡ßç‡¶§‡¶ö‡¶æ‡¶™)",
        "‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç / ‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 180 mg/dL)",
        "‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶æ‡¶π‡¶≤‡ßá skip ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)",
        "‡¶°‡ßã‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 500mg, skip ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)",
        "‡¶ï‡¶§‡¶¨‡¶æ‡¶∞ ‡¶ñ‡¶æ‡¶¨‡ßá‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¶‡¶ø‡¶®‡ßá ‡ß® ‡¶¨‡¶æ‡¶∞, skip ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)",
        "‡¶ï‡¶§‡¶¶‡¶ø‡¶® ‡¶ñ‡¶æ‡¶¨‡ßá‡¶® (‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ, skip ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)",
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ / ‡¶®‡ßã‡¶ü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤, skip ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)",
        "IPFS CID (‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßá‡¶®, ‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)"
      ];
      addMessage(questions[recordStep]);
    }

    // ========================================
    //          ‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
    // ========================================
    document.getElementById("sendBtn").onclick = async () => {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, true);
      input.value = "";

      if (!signer) {
        addMessage("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      const lower = text.toLowerCase();

      // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
      if (fixedProfileStep >= 0) {
        if (lower === "skip" || lower === "‡¶®‡¶æ‡¶á" || !text) {
          addMessage("‡¶è‡¶á ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§");
          return;
        }

        switch (fixedProfileStep) {
          case 0:
            const [d, m, y] = text.split("-").map(Number);
            if (!d || !m || !y || isNaN(d)) return addMessage("‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: DD-MM-YYYY");
            const dateObj = new Date(y, m-1, d);
            profileData.dateOfBirth = Math.floor(dateObj.getTime() / 1000);
            break;
          case 1: profileData.gender = text.trim(); break;
          case 2: profileData.bloodGroup = text.trim(); break;
        }

        fixedProfileStep++;
        if (fixedProfileStep === 3) {
          try {
            const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            const tx = await c.setFixedProfile(
              profileData.dateOfBirth,
              profileData.gender,
              profileData.bloodGroup
            );
            addMessage(`‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            addMessage("‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            fixedProfileStep = -1;
            await checkProfiles();
          } catch (err) {
            addMessage("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown error"));
            fixedProfileStep = -1;
          }
        } else {
          askFixedProfile();
        }
        return;
      }

      // ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶¨‡¶≤ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
      if (updatableProfileStep >= 0) {
        const skipped = ["skip", "‡¶®‡¶æ‡¶á", ""].includes(lower);
        if (skipped && updatableProfileStep < 2) {
          addMessage("‡¶ì‡¶ú‡¶® ‡¶ì ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§");
          return;
        }

        switch (updatableProfileStep) {
          case 0: profileData.weightKg = parseInt(text) || 0; break;
          case 1: profileData.heightCm = parseInt(text) || 0; break;
          case 2: profileData.allergies = skipped ? [] : text.split(",").map(s => s.trim()).filter(Boolean); break;
          case 3: profileData.chronicDiseases = skipped ? [] : text.split(",").map(s => s.trim()).filter(Boolean); break;
        }

        updatableProfileStep++;
        if (updatableProfileStep === 4) {
          try {
            const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            const tx = await c.updateProfile(
              profileData.weightKg,
              profileData.heightCm,
              profileData.allergies || [],
              profileData.chronicDiseases || []
            );
            addMessage(`‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
            updatableProfileStep = -1;
          } catch (err) {
            addMessage("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown error"));
            updatableProfileStep = -1;
          }
        } else {
          askUpdatableProfile();
        }
        return;
      }

      // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶Æ‡ßã‡¶°
      if (recordStep >= 0) {
        const skipped = ["skip", "‡¶®‡¶æ‡¶á", ""].includes(lower);

        switch (recordStep) {
          case 0: recordData.diseaseName    = text.trim() || ""; break;
          case 1: recordData.readingValue   = text.trim() || ""; break;
          case 2: recordData.medicineName   = skipped ? "" : text.trim(); break;
          case 3: recordData.dose           = skipped ? "" : text.trim(); break;
          case 4: recordData.frequency      = skipped ? "" : text.trim(); break;
          case 5: recordData.durationDays   = skipped ? 0 : (parseInt(text) || 0); break;
          case 6: recordData.diseaseDetails = skipped ? "" : text.trim(); break;
          case 7: recordData.ipfsCid        = skipped ? "" : text.trim(); break;
        }

        recordStep++;

        if (recordStep === 8) {
          try {
            const functionSelector = "0xcaf5bb2c";
            const coder = new ethers.AbiCoder();

            const medicines = [];
            if (recordData.medicineName && recordData.medicineName.trim() !== "" && recordData.medicineName.toLowerCase() !== "skip") {
              medicines.push([
                recordData.medicineName.trim(),
                recordData.dose || "",
                recordData.frequency || "",
                BigInt(recordData.durationDays || 0)
              ]);
            }

            const encodedParams = coder.encode(
              ["string", "string", "tuple(string,string,string,uint256)[]", "string", "string"],
              [
                recordData.diseaseName || "",
                recordData.readingValue || "",
                medicines,
                recordData.ipfsCid || "",
                recordData.diseaseDetails || ""
              ]
            );

            const fullCalldata = functionSelector + encodedParams.slice(2);

            const tx = await signer.sendTransaction({
              to: CONTRACT_ADDRESS,
              data: fullCalldata
            });

            addMessage(`‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            addMessage("‡¶∏‡¶´‡¶≤! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ '‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì' ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
            recordStep = -1;
          } catch (err) {
            console.error("Record add error:", err);
            let msgText = "‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ";
            if (err.reason) msgText += `: ${err.reason}`;
            else if (err.message) msgText += `: ${err.message}`;
            addMessage(msgText);
            recordStep = -1;
          }
        } else {
          askRecord();
        }
        return;
      }

      // ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°
      if (lower.includes("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì") || lower.includes("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø") || lower.includes("record") || lower.includes("history")) {
        try {
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          const records = await c.getAllDiseaseRecords(userAddress);

          let reply = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶∏‡¶Æ‡ßÇ‡¶π:\n\n";
          if (records.length === 0) {
            reply += "‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§";
          } else {
            records.forEach(disease => {
              reply += `‡¶∞‡ßã‡¶ó: ${disease.diseaseName}\n`;
              disease.dailyRecords.forEach(r => {
                const date = new Date(Number(r.timestamp) * 1000).toLocaleString("bn-BD");
                reply += ` ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${date}\n`;
                reply += ` ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç: ${r.readingValue}\n`;
                reply += ` ‡¶¨‡¶Ø‡¶º‡¶∏: ${r.patientAgeAtRecord} ‡¶¨‡¶õ‡¶∞\n`;
                reply += ` ‡¶ì‡¶ú‡¶®: ${r.patientWeightKg} kg   ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ: ${r.patientHeightCm} cm\n`;

                if (r.medicines.length > 0) {
                  reply += " ‡¶ì‡¶∑‡ßÅ‡¶ß:\n";
                  r.medicines.forEach(m => {
                    reply += ` ‚Ä¢ ${m.name} (${m.dose}, ${m.frequency}, ${m.durationDays} ‡¶¶‡¶ø‡¶®)\n`;
                  });
                }

                if (r.diseaseDetails) reply += ` ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§: ${r.diseaseDetails}\n`;
                reply += "\n";
              });
            });
          }

          addMessage(reply);
          updateChart(records);
        } catch (err) {
          addMessage("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.message || "Unknown error"));
        }
        return;
      }

      if (lower.includes("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°") || lower.includes("add") || lower.includes("‡¶Ø‡ßã‡¶ó") || lower.includes("‡¶®‡¶§‡ßÅ‡¶®")) {
        recordStep = 0;
        recordData = {};
        addMessage("‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶õ‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
        askRecord();
        return;
      }

      if (["‡¶π‡¶æ‡¶á", "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã", "‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã", "‡¶π‡ßá‡¶≤‡ßã"].some(w => lower.includes(w))) {
        addMessage("‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üòä ‡¶Ü‡¶Æ‡¶ø ‡¶≠‡¶æ‡¶≤‡ßã ‡¶Ü‡¶õ‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?");
        return;
      }

      addMessage("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶Æ‡¶ø ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø‡•§ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:\n‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì\n‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã\n‚Ä¢ ‡¶π‡¶æ‡¶á / ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã");
    };

    // ========================================
    //          ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    // ========================================
    function updateChart(records) {
      const ctx = document.getElementById("recordChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      if (!records || records.length === 0) {
        document.getElementById("recordChart").style.display = "none";
        return;
      }

      document.getElementById("recordChart").style.display = "block";

      const labels = [];
      const data = [];

      records.forEach(disease => {
        disease.dailyRecords.forEach(r => {
          labels.push(`${disease.diseaseName} - ${new Date(Number(r.timestamp)*1000).toLocaleDateString("bn-BD")}`);
          const val = parseFloat(r.readingValue?.split(" ")[0]) || 0;
          data.push(val);
        });
      });

      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶Æ‡¶æ‡¶®",
            data,
            borderColor: "#009688",
            backgroundColor: "rgba(0,150,136,0.18)",
            fill: true,
            tension: 0.35,
            pointRadius: 4,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: "top" },
            title: { display: true, text: "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°", font: { size: 16 } }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // ========================================
    //          ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
    // ========================================
    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("logoutBtn").onclick = disconnectWallet;

    document.getElementById("userInput").addEventListener("keypress", e => {
      if (e.key === "Enter") document.getElementById("sendBtn").click();
    });
  </script>
</body>
</html>
