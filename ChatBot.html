<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Doctor - Patient Records Chatbot</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #e0f7fa, #b2ebf2); color: #333; }
    h1 { text-align: center; color: #00695c; margin-bottom: 10px; }
    #chat-container { max-width: 720px; margin: 0 auto 20px; background: white; border-radius: 16px; box-shadow: 0 6px 25px rgba(0,0,0,0.12); overflow: hidden; }
    #chat-header { background: linear-gradient(90deg, #009688, #00796b); color: white; padding: 18px; text-align: center; font-weight: bold; font-size: 1.3em; }
    #chat-body { height: 420px; overflow-y: auto; padding: 20px; background: #f8f9fa; }
    .message { margin: 14px 0; padding: 14px 20px; border-radius: 20px; max-width: 82%; line-height: 1.5; word-wrap: break-word; }
    .user { background: #009688; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
    .bot { background: #e0f2f1; color: #004d40; margin-right: auto; border-bottom-left-radius: 4px; }
    .ai { background: #fff3e0; color: #ef6c00; margin-right: auto; border-left: 4px solid #ef6c00; }
    #input-area { display: flex; padding: 16px; background: white; border-top: 1px solid #e0e0e0; }
    #userInput { flex: 1; padding: 14px 18px; border: 1px solid #ccc; border-radius: 30px; outline: none; font-size: 1em; }
    #sendBtn { margin-left: 12px; padding: 14px 28px; background: #009688; color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }
    .auth-buttons { text-align: center; margin: 20px 0; }
    #connectBtn, #logoutBtn { padding: 14px 32px; border: none; border-radius: 30px; cursor: pointer; font-size: 1.1em; margin: 0 12px; }
    #connectBtn { background: #ff5722; color: white; }
    #logoutBtn { background: #e74c3c; color: white; display: none; }
    #status { text-align: center; margin: 15px; color: #444; font-size: 1.05em; font-weight: 500; }
    canvas { margin: 25px auto; display: block; max-width: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
  </style>
</head>
<body>
  <h1>AI Doctor - Patient Records Chatbot</h1>

  <div id="chat-container">
    <div id="chat-header">Arc Testnet - LifeHealth Chain</div>
    <div id="chat-body">
      <div class="message bot">‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üëã ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§  
‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶¨‡¶≤‡ßã ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì‡•§  
‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:  
‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø  
‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã</div>
    </div>
    <div id="input-area">
      <input type="text" id="userInput" placeholder="‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®..." />
      <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
  </div>

  <div class="auth-buttons">
    <button id="connectBtn">‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Arc Testnet)</button>
    <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü / ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü</button>
  </div>

  <div id="status">Status: Not connected</div>

  <canvas id="recordChart" width="500" height="280"></canvas>

  <script>
    const contractAddress = "0x1cA1699c69852Eb81D4eb68Da33ac61D064f7Be1";

    const abi = [
      // ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ABI (‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßã ‡¶¨‡¶æ Remix ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶æ‡¶ì)
      // ... (‡¶™‡ßÅ‡¶∞‡ßã ABI ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßã)
    ];

    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let chartInstance = null;

    // Profile setup state
    let fixedProfileSetupStep = -1;
    let updatableProfileSetupStep = -1;
    let profileData = {};

    // Record setup state
    let recordSetupStep = -1;
    let recordData = {};

    function addMessage(text, isUser = false, isAI = false) {
      const chatBody = document.getElementById("chat-body");
      const msgDiv = document.createElement("div");
      msgDiv.className = "message " + (isUser ? "user" : isAI ? "ai" : "bot");
      msgDiv.innerText = text;
      chatBody.appendChild(msgDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function connectWallet() {
      const status = document.getElementById("status");
      status.innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

      if (!window.ethereum) {
        status.innerText = "‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!";
        addMessage("MetaMask ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        if (Number(network.chainId) !== 5042002) {
          status.innerText = "Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶® (Chain ID: 5042002)";
          addMessage("Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®!");
          return;
        }

        contract = new ethers.Contract(contractAddress, abi, signer);

        status.innerText = `‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
        addMessage(`‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®:  
‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø  
‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã`);

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("userInput").disabled = false;

        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá fixed profile ‡¶ö‡ßá‡¶ï
        let fixedProfile = null;
        try {
          fixedProfile = await contract.getFixedProfile(userAddress);
        } catch (err) {
          // ‡¶è‡¶∞‡¶∞ ‡¶è‡¶≤‡ßá‡¶ì ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶¨‡ßá
        }

        if (!fixedProfile || fixedProfile.dateOfBirth === 0n) {
          addMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ (‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ, ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó, ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™) ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶∏‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡¶ø‡¶®‡•§");
          fixedProfileSetupStep = 0;
          askForFixedProfile();
        } else {
          // fixed profile ‡¶Ü‡¶õ‡ßá, ‡¶è‡¶ñ‡¶® updatable profile ‡¶ö‡ßá‡¶ï
          let profile = null;
          try {
            profile = await contract.getPatientProfile(userAddress);
          } catch (err) {
            // ‡¶è‡¶∞‡¶∞ ‡¶è‡¶≤‡ßá‡¶ì ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶¨‡ßá
          }

          if (!profile || profile.weightKg === 0n || profile.heightCm === 0n) {
            addMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ (‡¶ì‡¶ú‡¶®, ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø) ‡¶™‡ßÅ‡¶∞‡ßã‡¶™‡ßÅ‡¶∞‡¶ø ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶∏‡ßÅ‡¶® ‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡¶ø‡¶®‡•§");
            updatableProfileSetupStep = 0;
            askForUpdatableProfile();
          } else {
            addMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
          }
        }
      } catch (error) {
        status.innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message;
        addMessage("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message);
      }
    }

    function disconnectWallet() {
      provider = null;
      signer = null;
      contract = null;
      userAddress = null;
      fixedProfileSetupStep = -1;
      updatableProfileSetupStep = -1;
      recordSetupStep = -1;

      document.getElementById("status").innerText = "Status: Disconnected";
      document.getElementById("connectBtn").style.display = "block";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("sendBtn").disabled = true;
      document.getElementById("userInput").disabled = true;

      addMessage("‡¶Ü‡¶™‡¶®‡¶ø ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü / ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");

      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
    }

    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("logoutBtn").onclick = disconnectWallet;

    // Fixed profile questions
    function askForFixedProfile() {
      const steps = [
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (DD-MM-YYYY)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (Male/Female/Other)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® A+, O-)"
      ];

      addMessage(steps[fixedProfileSetupStep]);
    }

    // Updatable profile questions
    function askForUpdatableProfile() {
      const steps = [
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶ú‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (kg)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (cm)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ú‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡ßü‡¶æ‡¶¶‡¶ø ‡¶∞‡ßã‡¶ó ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)"
      ];

      addMessage(steps[updatableProfileSetupStep]);
    }

    // Record setup questions
    function askForRecord() {
      const steps = [
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® Diabetes)",
        "‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® 180 mg/dL)",
        "‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® Metformin)",
        "‡¶°‡ßã‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® 500mg)",
        "‡¶´‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® 3 times/day)",
        "‡¶ï‡¶§‡¶¶‡¶ø‡¶® ‡¶ñ‡¶æ‡¶¨‡ßá‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶¶‡¶ø‡¶®)",
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶•‡ßç‡¶Ø/‡¶®‡ßã‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)",
        "IPFS CID ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¶‡¶ø‡¶® (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)"
      ];

      addMessage(steps[recordSetupStep]);
    }

    document.getElementById("sendBtn").onclick = async () => {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, true);
      input.value = "";

      if (!contract) {
        addMessage("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
        return;
      }

      const lower = text.toLowerCase();

      // Fixed profile setup mode
      if (fixedProfileSetupStep >= 0) {
        if (lower === "skip" || lower === "‡¶®‡¶æ‡¶á" || lower === "") {
          addMessage("‡¶è‡¶á ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§");
          return;
        } else {
          switch (fixedProfileSetupStep) {
            case 0:
              const [day, month, year] = text.split("-");
              if (!day || !month || !year) {
                addMessage("‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®: DD-MM-YYYY");
                return;
              }
              const date = new Date(year, month - 1, day);
              profileData.dateOfBirth = Math.floor(date.getTime() / 1000);
              break;
            case 1:
              profileData.gender = text;
              break;
            case 2:
              profileData.bloodGroup = text;
              break;
          }
        }

        fixedProfileSetupStep++;
        if (fixedProfileSetupStep === 3) {
          try {
            const tx = await contract.setFixedProfile(
              profileData.dateOfBirth,
              profileData.gender,
              profileData.bloodGroup
            );
            addMessage("‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: " + tx.hash);
            await tx.wait();
            addMessage("‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");

            // ‡¶è‡¶ñ‡¶® updatable profile ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßã
            fixedProfileSetupStep = -1;
            try {
              const profile = await contract.getPatientProfile(userAddress);
              if (profile.weightKg === 0n || profile.heightCm === 0n) {
                addMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶ú‡¶®/‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ/‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ú‡¶ø/‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡ßü‡¶æ‡¶¶‡¶ø ‡¶∞‡ßã‡¶ó ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶∏‡ßÅ‡¶® ‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡¶ø‡¶®‡•§");
                updatableProfileSetupStep = 0;
                askForUpdatableProfile();
              } else {
                addMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
              }
            } catch (err) {
              addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message);
            }
          } catch (err) {
            addMessage("‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message);
            fixedProfileSetupStep = -1;
          }
        } else {
          askForFixedProfile();
        }
        return;
      }

      // Updatable profile setup mode
      if (updatableProfileSetupStep >= 0) {
        if (lower === "skip" || lower === "‡¶®‡¶æ‡¶á" || lower === "") {
          if (updatableProfileSetupStep >= 2) {
            profileData.allergies = updatableProfileSetupStep === 2 ? [] : profileData.allergies || [];
            profileData.chronicDiseases = updatableProfileSetupStep === 3 ? [] : profileData.chronicDiseases || [];
            updatableProfileSetupStep = 4;
          } else {
            addMessage("‡¶è‡¶á ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§");
            return;
          }
        } else {
          switch (updatableProfileSetupStep) {
            case 0:
              profileData.weightKg = parseInt(text);
              break;
            case 1:
              profileData.heightCm = parseInt(text);
              break;
            case 2:
              profileData.allergies = text.split(",").map(a => a.trim());
              break;
            case 3:
              profileData.chronicDiseases = text.split(",").map(a => a.trim());
              break;
          }
        }

        updatableProfileSetupStep++;
        if (updatableProfileSetupStep === 4) {
          try {
            const tx = await contract.updateProfile(
              profileData.weightKg,
              profileData.heightCm,
              profileData.allergies,
              profileData.chronicDiseases
            );
            addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: " + tx.hash);
            await tx.wait();
            addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
            updatableProfileSetupStep = -1;
          } catch (err) {
            addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message);
            updatableProfileSetupStep = -1;
          }
        } else {
          askForUpdatableProfile();
        }
        return;
      }

      // Record setup mode
      if (recordSetupStep >= 0) {
        // ... (‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶∞‡¶æ‡¶ñ‡ßã)
      }

      // Normal commands
      if (lower.includes("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì") || lower.includes("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø")) {
        try {
          const records = await contract.getAllDiseaseRecords(userAddress);
          let reply = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°:\n\n";
          if (records.length === 0) {
            reply += "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
          } else {
            // ... (‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶∞‡¶æ‡¶ñ‡ßã)
          }
          addMessage(reply);
          updateChart(records);
        } catch (error) {
          addMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
      }
      else if (lower.includes("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°") || lower.includes("add") || lower.includes("‡¶Ø‡ßã‡¶ó") || lower.includes("‡¶®‡¶§‡ßÅ‡¶®")) {
        recordSetupStep = 0;
        recordData = {};
        addMessage("‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶õ‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
        askForRecord();
      }
      else if (lower.includes("‡¶π‡¶æ‡¶á") || lower.includes("‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã") || lower.includes("‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã") || lower.includes("‡¶π‡ßá‡¶≤‡ßã")) {
        addMessage("‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üòä ‡¶Ü‡¶Æ‡¶ø ‡¶≠‡¶æ‡¶≤‡ßã ‡¶Ü‡¶õ‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡ßü‡ßá ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?");
      }
      else {
        addMessage("‡¶Ü‡¶Æ‡¶ø ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø‡•§ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:\n‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø\n‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã\n‚Ä¢ ‡¶π‡¶æ‡¶á / ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã");
      }
    };

    function updateChart(records) {
      // ... (‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶∞‡¶æ‡¶ñ‡ßã)
    }
  </script>
</body>
</html>
