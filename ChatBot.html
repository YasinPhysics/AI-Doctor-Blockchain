<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Doctor - Patient Records Chatbot</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <script src="https://unpkg.com/nft.storage/dist/bundle.min.js"></script>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #e0f7fa, #b2ebf2); 
      color: #333; 
    }
    h1 { text-align: center; color: #00695c; margin-bottom: 10px; }
    #chat-container { 
      max-width: 720px; 
      margin: 0 auto 20px; 
      background: white; 
      border-radius: 16px; 
      box-shadow: 0 6px 25px rgba(0,0,0,0.12); 
      overflow: hidden; 
    }
    #chat-header { 
      background: linear-gradient(90deg, #009688, #00796b); 
      color: white; 
      padding: 18px; 
      text-align: center; 
      font-weight: bold; 
      font-size: 1.3em; 
    }
    #chat-body { 
      height: 420px; 
      overflow-y: auto; 
      padding: 20px; 
      background: #f8f9fa; 
    }
    .message { 
      margin: 14px 0; 
      padding: 14px 20px; 
      border-radius: 20px; 
      max-width: 82%; 
      line-height: 1.5; 
      word-wrap: break-word; 
    }
    .user { 
      background: #009688; 
      color: white; 
      margin-left: auto; 
      border-bottom-right-radius: 4px; 
    }
    .bot { 
      background: #e0f2f1; 
      color: #004d40; 
      margin-right: auto; 
      border-bottom-left-radius: 4px; 
    }
    .ai { 
      background: #fff3e0; 
      color: #ef6c00; 
      margin-right: auto; 
      border-left: 4px solid #ef6c00; 
    }
    #input-area { 
      display: flex; 
      padding: 16px; 
      background: white; 
      border-top: 1px solid #e0e0e0; 
    }
    #userInput { 
      flex: 1; 
      padding: 14px 18px; 
      border: 1px solid #ccc; 
      border-radius: 30px; 
      outline: none; 
      font-size: 1em; 
    }
    #sendBtn { 
      margin-left: 12px; 
      padding: 14px 28px; 
      background: #009688; 
      color: white; 
      border: none; 
      border-radius: 30px; 
      cursor: pointer; 
      font-weight: bold; 
    }
    .auth-buttons { 
      text-align: center; 
      margin: 20px 0; 
    }
    #connectBtn, #logoutBtn { 
      padding: 14px 32px; 
      border: none; 
      border-radius: 30px; 
      cursor: pointer; 
      font-size: 1.1em; 
      margin: 0 12px; 
    }
    #connectBtn { background: #ff5722; color: white; }
    #logoutBtn { background: #e74c3c; color: white; display: none; }
    #status { 
      text-align: center; 
      margin: 15px; 
      color: #444; 
      font-size: 1.05em; 
      font-weight: 500; 
    }
    canvas { 
      margin: 25px auto; 
      display: block; 
      max-width: 100%; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
    }
  </style>
</head>
<body>
  <h1>AI Doctor - Patient Records Chatbot</h1>

  <div id="chat-container">
    <div id="chat-header">Arc Testnet - LifeHealth Chain</div>
    <div id="chat-body">
      <div class="message bot">‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üëã ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§  
‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶¨‡¶≤‡ßã ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì‡•§  
‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:  
‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø  
‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã: Fever 2025-02-10  
‚Ä¢ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶ï‡ßÄ ‡¶ï‡ßÄ?  
‚Ä¢ ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã</div>
    </div>
    <div id="input-area">
      <input type="text" id="userInput" placeholder="‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®..." />
      <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
  </div>

  <div class="auth-buttons">
    <button id="connectBtn">‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Arc Testnet)</button>
    <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü / ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü</button>
  </div>

  <div id="status">Status: Not connected</div>

  <canvas id="recordChart" width="500" height="280"></canvas>

  <script>
    const contractAddress = "0xa897d5FC62358637F74e7Db70f54BA9EB82Bc3f2";

    const abi = [
      {"inputs":[{"internalType":"address","name":"patient","type":"address"},{"internalType":"string","name":"_cid","type":"string"}],"name":"addRecord","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getRecords","outputs":[{"components":[{"internalType":"string","name":"cid","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct PatientRecords.Record[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"}
    ];

    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let chartInstance = null;

    const ENCRYPTION_KEY = "LifeHealthSecretKey2026";

    // nft.storage client (Vercel-‡¶è NFT_STORAGE_KEY ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá)
    const nftStorageClient = new NFTStorage({ token: process.env.NFT_STORAGE_KEY });

    function encryptData(data) {
      return CryptoJS.AES.encrypt(data, ENCRYPTION_KEY).toString();
    }

    function decryptData(ciphertext) {
      const bytes = CryptoJS.AES.decrypt(ciphertext, ENCRYPTION_KEY);
      return bytes.toString(CryptoJS.enc.Utf8);
    }

    async function uploadToIPFS(data) {
      const encrypted = encryptData(data);
      const blob = new Blob([encrypted], { type: 'text/plain' });
      const cid = await nftStorageClient.storeBlob(blob);
      return cid.toString();
    }

    async function fetchFromIPFS(cid) {
      const url = `https://${cid}.ipfs.nftstorage.link`;
      const response = await fetch(url);
      if (!response.ok) throw new Error("IPFS fetch failed");
      const encrypted = await response.text();
      return decryptData(encrypted);
    }

    function addMessage(text, isUser = false, isAI = false) {
      const chatBody = document.getElementById("chat-body");
      const msgDiv = document.createElement("div");
      msgDiv.className = "message " + (isUser ? "user" : isAI ? "ai" : "bot");
      msgDiv.innerText = text;
      chatBody.appendChild(msgDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function connectWallet() {
      const status = document.getElementById("status");
      status.innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

      if (!window.ethereum) {
        status.innerText = "‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!";
        addMessage("MetaMask ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        if (Number(network.chainId) !== 5042002) {
          status.innerText = "Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶® (Chain ID: 5042002)";
          addMessage("Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®!");
          return;
        }

        contract = new ethers.Contract(contractAddress, abi, signer);

        status.innerText = `‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
        addMessage(`‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®:  
‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø  
‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã: [‡¶°‡¶æ‡¶ü‡¶æ]  
‚Ä¢ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶ï‡ßÄ ‡¶ï‡ßÄ?  
‚Ä¢ ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã`);

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("userInput").disabled = false;
      } catch (error) {
        status.innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message;
        addMessage("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message);
      }
    }

    function disconnectWallet() {
      provider = null;
      signer = null;
      contract = null;
      userAddress = null;

      document.getElementById("status").innerText = "Status: Disconnected";
      document.getElementById("connectBtn").style.display = "block";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("sendBtn").disabled = true;
      document.getElementById("userInput").disabled = true;

      addMessage("‡¶Ü‡¶™‡¶®‡¶ø ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü / ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");

      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
    }

    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("logoutBtn").onclick = disconnectWallet;

    document.getElementById("sendBtn").onclick = async () => {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, true);
      input.value = "";

      if (!contract) {
        addMessage("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
        return;
      }

      const lower = text.toLowerCase();

      if (
        lower.includes("‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì") ||
        lower.includes("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°") ||
        lower.includes("records") ||
        lower.includes("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø") ||
        lower.includes("‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã") ||
        lower.includes("‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ") ||
        lower.includes("‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°") ||
        lower.includes("‡¶ï‡ßÄ ‡¶Ü‡¶õ‡ßá") ||
        lower.includes("‡¶≤‡¶ø‡¶∏‡ßç‡¶ü") ||
        lower.includes("‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶ï‡ßÄ ‡¶ï‡ßÄ") ||
        lower.includes("medicine") ||
        lower.includes("‡¶î‡¶∑‡¶ß")
      ) {
        try {
          const records = await contract.getRecords(userAddress);
          let reply = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°:\n\n";
          let medicines = [];
          if (records.length === 0) {
            reply += "‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
          } else {
            for (const rec of records) {
              const cid = rec.cid;
              try {
                const decrypted = await fetchFromIPFS(cid);
                reply += `‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°: ${decrypted} (${new Date(Number(rec.timestamp)*1000).toLocaleString()})\n`;
                if (decrypted.toLowerCase().includes("medicine") || decrypted.toLowerCase().includes("‡¶ì‡¶∑‡ßÅ‡¶ß")) {
                  medicines.push(decrypted);
                }
              } catch (err) {
                reply += `‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° (CID: ${cid}): ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ\n`;
              }
            }
            if (medicines.length > 0) {
              reply += "\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:\n" + medicines.join("\n");
            }
          }
          addMessage(reply);
          updateChart(records);

          // Groq AI ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂
          if (records.length > 0) {
            try {
              const response = await fetch('/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  records: records.map(r => ({ encryptedData: r.encryptedData, timestamp: r.timestamp.toString() })),
                  userMessage: "‡¶è‡¶á ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶π‡¶ú ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶¶‡¶æ‡¶ì‡•§"
                })
              });

              if (!response.ok) throw new Error(`API error: ${response.status}`);

              const data = await response.json();
              if (data.advice) {
                addMessage("AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂:\n" + data.advice, false, true);
              }
            } catch (err) {
              addMessage("AI ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶™‡ßá‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message);
            }
          }
        } catch (error) {
          addMessage("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (error.reason || error.message));
        }
      }
      else if (
        lower.includes("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°") ||
        lower.includes("add") ||
        lower.includes("‡¶Ø‡ßã‡¶ó") ||
        lower.includes("‡¶®‡¶§‡ßÅ‡¶®") ||
        lower.includes("‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø") ||
        lower.includes("‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°") ||
        lower.includes("‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßã") ||
        lower.includes("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßã")
      ) {
        let data = text;

        const keywords = ["‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã", "add", "‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã", "‡¶®‡¶§‡ßÅ‡¶®", "‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø", "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßã", "‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßã"];
        for (const kw of keywords) {
          if (lower.includes(kw)) {
            data = text.split(kw)[1]?.trim() || text;
            break;
          }
        }
        if (text.includes(":")) {
          data = text.split(":").slice(1).join(":").trim();
        }

        if (!data || data.length < 3) {
          addMessage("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§ ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:\n‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã: Fever 2025-02-10\n‡¶®‡¶§‡ßÅ‡¶®: BP 120/80");
          return;
        }

        try {
          addMessage("‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü + IPFS-‡¶è ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
          const cid = await uploadToIPFS(data);
          const tx = await contract.addRecord(userAddress, cid);
          addMessage("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: " + tx.hash);
          await tx.wait();
          addMessage("‡¶∏‡¶´‡¶≤! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá (CID: " + cid + ")‡•§ '‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì' ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
        } catch (error) {
          addMessage("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message);
        }
      }
      else if (lower.includes("‡¶π‡¶æ‡¶á") || lower.includes("‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã") || lower.includes("‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã") || lower.includes("‡¶π‡ßá‡¶≤‡ßã")) {
        addMessage("‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üòä ‡¶Ü‡¶Æ‡¶ø ‡¶≠‡¶æ‡¶≤‡ßã ‡¶Ü‡¶õ‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡ßü‡ßá ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?");
      }
      else {
        addMessage("‡¶Ü‡¶Æ‡¶ø ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø‡•§ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:\n‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø / ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶ï‡ßÄ ‡¶ï‡ßÄ\n‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã: [‡¶°‡¶æ‡¶ü‡¶æ] / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°\n‚Ä¢ ‡¶π‡¶æ‡¶á / ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã");
      }
    };

    function updateChart(records) {
      const ctx = document.getElementById("recordChart").getContext("2d");

      if (chartInstance) chartInstance.destroy();

      if (records.length === 0) {
        document.getElementById("recordChart").style.display = "none";
        return;
      }

      document.getElementById("recordChart").style.display = "block";

      const labels = records.map((_, i) => `‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ${i+1}`);
      const timestamps = records.map(rec => Number(rec.timestamp));
      const colors = records.map(rec => {
        const data = rec.encryptedData.toLowerCase();
        if (data.includes("fever") || data.includes("‡¶ú‡ßç‡¶¨‡¶∞")) return "#e74c3c";
        if (data.includes("bp") || data.includes("pressure") || data.includes("‡¶∞‡¶ï‡ßç‡¶§‡¶ö‡¶æ‡¶™")) return "#f39c12";
        if (data.includes("diabetes") || data.includes("‡¶°‡¶æ‡ßü‡¶æ‡¶¨‡ßá‡¶ü‡¶ø‡¶∏")) return "#27ae60";
        if (data.includes("medicine") || data.includes("‡¶ì‡¶∑‡ßÅ‡¶ß") || data.includes("paracetamol") || data.includes("aspirin")) return "#8e44ad";
        return "#3498db";
      });

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü',
            data: timestamps,
            backgroundColor: colors,
            borderColor: colors.map(c => c + '88'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: '‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶≤‡¶æ‡¶á‡¶® (‡¶∞‡ßã‡¶ó/‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞)' }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Timestamp' } }
          }
        }
      });
    }
  </script>
</body>
</html>
