<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ - ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #009688;
      --primary-dark: #00796b;
      --accent: #ff5722;
      --bg: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      --card: white;
      --text: #004d40;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: #333;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: var(--primary-dark);
      margin-bottom: 20px;
    }

    #chat-container {
      max-width: 760px;
      margin: 0 auto 30px;
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      overflow: hidden;
    }

    #chat-header {
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 18px;
      text-align: center;
      font-weight: 600;
      font-size: 1.35rem;
    }

    #chat-body {
      height: 460px;
      overflow-y: auto;
      padding: 24px;
      background: #f8f9fa;
    }

    .message {
      margin: 16px 0;
      padding: 14px 20px;
      border-radius: 22px;
      max-width: 84%;
      line-height: 1.55;
      word-wrap: break-word;
      font-size: 1.02rem;
    }

    .user {
      background: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 6px;
    }

    .bot {
      background: #e0f2f1;
      color: var(--text);
      margin-right: auto;
      border-bottom-left-radius: 6px;
    }

    #input-area {
      display: flex;
      padding: 16px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
    }

    #userInput {
      flex: 1;
      padding: 14px 20px;
      border: 1px solid #ccc;
      border-radius: 50px;
      outline: none;
      font-size: 1.05rem;
    }

    #userInput:focus {
      border-color: var(--primary);
    }

    #sendBtn {
      margin-left: 12px;
      padding: 0 28px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
    }

    .auth-buttons {
      text-align: center;
      margin: 24px 0;
    }

    #connectBtn, #logoutBtn {
      padding: 14px 40px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 10px;
    }

    #connectBtn {
      background: var(--accent);
      color: white;
    }

    #logoutBtn {
      background: #e74c3c;
      color: white;
      display: none;
    }

    #status {
      text-align: center;
      margin: 16px 0;
      color: #555;
      font-weight: 500;
    }

    canvas {
      margin: 30px auto;
      display: block;
      max-width: 100%;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <h1>AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ - ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</h1>

  <div id="chat-container">
    <div id="chat-header">Arc Testnet - LifeHealth Chain</div>
    <div id="chat-body">
      <div class="message bot">
        ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üëã ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§<br><br>
        ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶¨‡¶≤‡ßã ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì:<br>
        ‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br>
        ‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã
      </div>
    </div>

    <div id="input-area">
      <input type="text" id="userInput" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." autocomplete="off" />
      <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
  </div>

  <div class="auth-buttons">
    <button id="connectBtn">‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Arc Testnet)</button>
    <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
  </div>

  <div id="status">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶®‡¶Ø‡¶º</div>

  <canvas id="recordChart" width="600" height="300"></canvas>

  <script>
    const CONTRACT_ADDRESS = "0x1cA1699c69852Eb81D4eb68Da33ac61D064f7Be1";

    const ABI = [
      // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ø‡ßá‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (‡¶™‡ßÅ‡¶∞‡ßã ABI ‡¶®‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá‡¶ì ‡¶ö‡¶≤‡¶¨‡ßá)
      {"inputs":[{"internalType":"uint256","name":"_dateOfBirth","type":"uint256"},{"internalType":"string","name":"_gender","type":"string"},{"internalType":"string","name":"_bloodGroup","type":"string"}],"name":"setFixedProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"_weightKg","type":"uint256"},{"internalType":"uint256","name":"_heightCm","type":"uint256"},{"internalType":"string[]","name":"_allergies","type":"string[]"},{"internalType":"string[]","name":"_chronicDiseases","type":"string[]"}],"name":"updateProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"_diseaseName","type":"string"},{"internalType":"string","name":"_readingValue","type":"string"},{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"dose","type":"string"},{"internalType":"string","name":"frequency","type":"string"},{"internalType":"uint256","name":"durationDays","type":"uint256"}],"internalType":"struct LifeHealthChain.Medicine[]","name":"_medicines","type":"tuple[]"},{"internalType":"string","name":"_ipfsCid","type":"string"},{"internalType":"string","name":"_diseaseDetails","type":"string"}],"name":"addDailyRecord","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getAllDiseaseRecords","outputs":[{"components":[{"internalType":"string","name":"diseaseName","type":"string"},{"components":[{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"readingValue","type":"string"},{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"dose","type":"string"},{"internalType":"string","name":"frequency","type":"string"},{"internalType":"uint256","name":"durationDays","type":"uint256"}],"internalType":"struct LifeHealthChain.Medicine[]","name":"medicines","type":"tuple[]"},{"internalType":"string","name":"ipfsCid","type":"string"},{"internalType":"address","name":"addedBy","type":"address"},{"internalType":"uint256","name":"patientAgeAtRecord","type":"uint256"},{"internalType":"uint256","name":"patientWeightKg","type":"uint256"},{"internalType":"uint256","name":"patientHeightCm","type":"uint256"}],"internalType":"struct LifeHealthChain.DailyRecord[]","name":"dailyRecords","type":"tuple[]"}],"internalType":"struct LifeHealthChain.DiseaseRecord[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getPatientProfile","outputs":[{"components":[{"internalType":"uint256","name":"weightKg","type":"uint256"},{"internalType":"uint256","name":"heightCm","type":"uint256"},{"internalType":"string[]","name":"allergies","type":"string[]"},{"internalType":"string[]","name":"chronicDiseases","type":"string[]"},{"internalType":"address[]","name":"allowedDoctors","type":"address[]"}],"internalType":"struct LifeHealthChain.PatientProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getFixedProfile","outputs":[{"internalType":"uint256","name":"dateOfBirth","type":"uint256"},{"internalType":"string","name":"gender","type":"string"},{"internalType":"string","name":"bloodGroup","type":"string"}],"stateMutability":"view","type":"function"}
    ];

    let provider, signer, userAddress;
    let fixedStep = -1, updateStep = -1, recordStep = -1;
    let profile = {}, record = {};
    let chart = null;

    function msg(text, user = false) {
      const div = document.createElement("div");
      div.className = `message ${user ? "user" : "bot"}`;
      div.textContent = text;
      document.getElementById("chat-body").appendChild(div);
      div.scrollIntoView({ behavior: "smooth" });
    }

    async function connect() {
      if (!window.ethereum) return msg("MetaMask ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");

      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        const net = await provider.getNetwork();
        if (Number(net.chainId) !== 5042002) return msg("Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("userInput").disabled = false;

        msg(`‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`);
        await checkProfile();
      } catch (e) {
        msg("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.message);
      }
    }

    document.getElementById("connectBtn").onclick = connect;
    document.getElementById("logoutBtn").onclick = () => location.reload();

    async function checkProfile() {
      try {
        const fixed = await new ethers.Contract(CONTRACT_ADDRESS, ABI, signer).getFixedProfile(userAddress);
        if (fixed.dateOfBirth !== 0n) {
          msg("‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶õ‡ßá‡•§");
          const p = await new ethers.Contract(CONTRACT_ADDRESS, ABI, signer).getPatientProfile(userAddress);
          if (p.weightKg > 0n && p.heightCm > 0n) {
            msg("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡•§ ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
          } else {
            updateStep = 0;
            askUpdate();
          }
        } else {
          fixedStep = 0;
          askFixed();
        }
      } catch {
        fixedStep = 0;
        askFixed();
      }
    }

    function askFixed() {
      const q = [
        "‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (DD-MM-YYYY)",
        "‡¶≤‡¶ø‡¶ô‡ßç‡¶ó (Male/Female/Other)",
        "‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ (‡¶Ø‡ßá‡¶Æ‡¶® A+)"
      ];
      msg(q[fixedStep]);
    }

    function askUpdate() {
      const q = [
        "‡¶ì‡¶ú‡¶® (kg)",
        "‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ (cm)",
        "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ú‡¶ø (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)",
        "‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡¶ø ‡¶∞‡ßã‡¶ó (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)"
      ];
      msg(q[updateStep]);
    }

    function askRecord() {
      const q = [
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ",
        "‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç / ‡¶Æ‡¶æ‡¶®",
        "‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (skip)",
        "‡¶°‡ßã‡¶ú (skip)",
        "‡¶´‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶∏‡¶ø (skip)",
        "‡¶ï‡¶§‡¶¶‡¶ø‡¶® (skip)",
        "‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶®‡ßã‡¶ü (skip)",
        "IPFS CID (skip)"
      ];
      msg(q[recordStep]);
    }

    document.getElementById("sendBtn").onclick = async () => {
      const input = document.getElementById("userInput");
      const txt = input.value.trim();
      if (!txt) return;
      msg(txt, true);
      input.value = "";

      if (!signer) return msg("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");

      const low = txt.toLowerCase();

      // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤
      if (fixedStep >= 0) {
        if (["skip","‡¶®‡¶æ‡¶á",""].includes(low)) return msg("‡¶è‡¶ü‡¶æ ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§");
        if (fixedStep === 0) {
          const [d,m,y] = txt.split("-");
          profile.dob = Math.floor(new Date(y, m-1, d).getTime()/1000);
        } else if (fixedStep === 1) profile.gender = txt;
        else profile.blood = txt;

        fixedStep++;
        if (fixedStep === 3) {
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          const tx = await c.setFixedProfile(profile.dob, profile.gender, profile.blood);
          msg(`Tx: ${tx.hash.slice(0,10)}...`);
          await tx.wait();
          msg("‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
          fixedStep = -1;
          checkProfile();
        } else askFixed();
        return;
      }

      // ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶¨‡¶≤ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤
      if (updateStep >= 0) {
        const skip = ["skip","‡¶®‡¶æ‡¶á",""].includes(low);
        if (skip && updateStep < 2) return msg("‡¶ì‡¶ú‡¶®/‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");

        if (updateStep === 0) profile.weight = parseInt(txt) || 0;
        else if (updateStep === 1) profile.height = parseInt(txt) || 0;
        else if (updateStep === 2) profile.allergies = skip ? [] : txt.split(",").map(s=>s.trim()).filter(Boolean);
        else profile.chronic = skip ? [] : txt.split(",").map(s=>s.trim()).filter(Boolean);

        updateStep++;
        if (updateStep === 4) {
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          const tx = await c.updateProfile(profile.weight, profile.height, profile.allergies, profile.chronic);
          msg(`Tx: ${tx.hash.slice(0,10)}...`);
          await tx.wait();
          msg("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
          updateStep = -1;
        } else askUpdate();
        return;
      }

      // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°
      if (recordStep >= 0) {
        const skip = ["skip","‡¶®‡¶æ‡¶á",""].includes(low);

        if (recordStep === 0) record.disease = txt.trim();
        else if (recordStep === 1) record.reading = txt.trim();
        else if (recordStep === 2) record.medName = skip ? "" : txt.trim();
        else if (recordStep === 3) record.dose = skip ? "" : txt.trim();
        else if (recordStep === 4) record.freq = skip ? "" : txt.trim();
        else if (recordStep === 5) record.days = skip ? 0 : (parseInt(txt) || 0);
        else if (recordStep === 6) record.details = skip ? "" : txt.trim();
        else record.ipfs = skip ? "" : txt.trim();

        recordStep++;
        if (recordStep === 8) {
          try {
            const selector = "0xcaf5bb2c";
            const coder = new ethers.AbiCoder();

            const meds = [];
            if (record.medName) {
              meds.push([record.medName, record.dose || "", record.freq || "", BigInt(record.days || 0)]);
            }

            const encodedParams = coder.encode(
              ["string","string","tuple(string,string,string,uint256)[]","string","string"],
              [record.disease || "", record.reading || "", meds, record.ipfs || "", record.details || ""]
            );

            const calldata = selector + encodedParams.slice(2);

            const tx = await signer.sendTransaction({
              to: CONTRACT_ADDRESS,
              data: calldata
            });

            msg(`‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            msg("‡¶∏‡¶´‡¶≤! ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
            recordStep = -1;
          } catch (e) {
            msg("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (e.reason || e.message || "Unknown"));
            recordStep = -1;
          }
        } else askRecord();
        return;
      }

      // ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°
      if (low.includes("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì") || low.includes("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø")) {
        try {
          const c = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
          const recs = await c.getAllDiseaseRecords(userAddress);
          let txt = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°:\n\n";
          if (recs.length === 0) txt += "‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§";
          else {
            recs.forEach(r => {
              txt += `‡¶∞‡ßã‡¶ó: ${r.diseaseName}\n`;
              r.dailyRecords.forEach(d => {
                txt += `‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date(Number(d.timestamp)*1000).toLocaleString("bn-BD")}\n`;
                txt += `‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç: ${d.readingValue}\n`;
                txt += `‡¶ì‡¶ú‡¶®: ${d.patientWeightKg} kg, ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ: ${d.patientHeightCm} cm\n`;
                if (d.medicines.length) {
                  txt += "‡¶ì‡¶∑‡ßÅ‡¶ß:\n";
                  d.medicines.forEach(m => txt += `‚Ä¢ ${m.name} (${m.dose}, ${m.frequency}, ${m.durationDays} ‡¶¶‡¶ø‡¶®)\n`);
                }
                if (d.diseaseDetails) txt += `‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§: ${d.diseaseDetails}\n`;
                txt += "\n";
              });
            });
          }
          msg(txt);
        } catch (e) {
          msg("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§");
        }
        return;
      }

      if (low.includes("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°") || low.includes("‡¶Ø‡ßã‡¶ó") || low.includes("‡¶®‡¶§‡ßÅ‡¶®")) {
        recordStep = 0;
        record = {};
        msg("‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá! ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
        askRecord();
        return;
      }

      msg("‡¶¨‡ßÅ‡¶ù‡¶ø‡¶®‡¶ø‡•§ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:\n‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì\n‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã\n‚Ä¢ ‡¶π‡¶æ‡¶á");
    };

    // ‡¶è‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßá‡¶∏‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶°
    document.getElementById("userInput").onkeypress = e => {
      if (e.key === "Enter") document.getElementById("sendBtn").click();
    };
  </script>
</body>
</html>
