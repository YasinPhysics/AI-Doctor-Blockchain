<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Doctor - Patient Records Chatbot</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #e0f7fa, #b2ebf2); color: #333; }
    h1 { text-align: center; color: #00695c; margin-bottom: 10px; }
    #chat-container { max-width: 720px; margin: 0 auto 20px; background: white; border-radius: 16px; box-shadow: 0 6px 25px rgba(0,0,0,0.12); overflow: hidden; }
    #chat-header { background: linear-gradient(90deg, #009688, #00796b); color: white; padding: 18px; text-align: center; font-weight: bold; font-size: 1.3em; }
    #chat-body { height: 420px; overflow-y: auto; padding: 20px; background: #f8f9fa; }
    .message { margin: 14px 0; padding: 14px 20px; border-radius: 20px; max-width: 82%; line-height: 1.5; word-wrap: break-word; }
    .user { background: #009688; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
    .bot { background: #e0f2f1; color: #004d40; margin-right: auto; border-bottom-left-radius: 4px; }
    #input-area { display: flex; padding: 16px; background: white; border-top: 1px solid #e0e0e0; }
    #userInput { flex: 1; padding: 14px 18px; border: 1px solid #ccc; border-radius: 30px; outline: none; font-size: 1em; }
    #sendBtn { margin-left: 12px; padding: 14px 28px; background: #009688; color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }
    .auth-buttons { text-align: center; margin: 20px 0; }
    #connectBtn, #logoutBtn { padding: 14px 32px; border: none; border-radius: 30px; cursor: pointer; font-size: 1.1em; margin: 0 12px; }
    #connectBtn { background: #ff5722; color: white; }
    #logoutBtn { background: #e74c3c; color: white; display: none; }
    #status { text-align: center; margin: 15px; color: #444; font-size: 1.05em; font-weight: 500; }
    canvas { margin: 25px auto; display: block; max-width: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
  </style>
</head>
<body>
  <h1>AI Doctor - Patient Records Chatbot</h1>
  <div id="chat-container">
    <div id="chat-header">Arc Testnet - LifeHealth Chain</div>
    <div id="chat-body">
      <div class="message bot">‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üëã ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§  
‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Arc Testnet), ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶¨‡¶≤‡ßÅ‡¶® ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®‡•§  
‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:  
‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø  
‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</div>
    </div>
    <div id="input-area">
      <input type="text" id="userInput" placeholder="‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®..." disabled />
      <button id="sendBtn" disabled>‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
  </div>

  <div class="auth-buttons">
    <button id="connectBtn">‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Arc Testnet)</button>
    <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü / ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü</button>
  </div>

  <div id="status">Status: Not connected</div>

  <canvas id="recordChart" width="500" height="280" style="display:none;"></canvas>

  <script>
    const contractAddress = "0x1cA1699c69852Eb81D4eb68Da33ac61D064f7Be1";

    const abi = [
      {"inputs":[{"internalType":"uint256","name":"_dateOfBirth","type":"uint256"},{"internalType":"string","name":"_gender","type":"string"},{"internalType":"string","name":"_bloodGroup","type":"string"}],"name":"setFixedProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"_weightKg","type":"uint256"},{"internalType":"uint256","name":"_heightCm","type":"uint256"},{"internalType":"string[]","name":"_allergies","type":"string[]"},{"internalType":"string[]","name":"_chronicDiseases","type":"string[]"}],"name":"updateProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"_doctor","type":"address"}],"name":"addAllowedDoctor","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"_doctor","type":"address"}],"name":"removeAllowedDoctor","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"_diseaseName","type":"string"},{"internalType":"string","name":"_readingValue","type":"string"},{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"dose","type":"string"},{"internalType":"string","name":"frequency","type":"string"},{"internalType":"uint256","name":"durationDays","type":"uint256"}],"internalType":"struct LifeHealthChain.Medicine[]","name":"_medicines","type":"tuple[]"},{"internalType":"string","name":"_ipfsCid","type":"string"},{"internalType":"string","name":"_diseaseDetails","type":"string"}],"name":"addDailyRecord","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getAllDiseaseRecords","outputs":[{"components":[{"internalType":"string","name":"diseaseName","type":"string"},{"components":[{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"readingValue","type":"string"},{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"dose","type":"string"},{"internalType":"string","name":"frequency","type":"string"},{"internalType":"uint256","name":"durationDays","type":"uint256"}],"internalType":"struct LifeHealthChain.Medicine[]","name":"medicines","type":"tuple[]"},{"internalType":"string","name":"ipfsCid","type":"string"},{"internalType":"address","name":"addedBy","type":"address"},{"internalType":"uint256","name":"patientAgeAtRecord","type":"uint256"},{"internalType":"uint256","name":"patientWeightKg","type":"uint256"},{"internalType":"uint256","name":"patientHeightCm","type":"uint256"}],"internalType":"struct LifeHealthChain.DailyRecord[]","name":"dailyRecords","type":"tuple[]"}],"internalType":"struct LifeHealthChain.DiseaseRecord[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getPatientProfile","outputs":[{"components":[{"internalType":"uint256","name":"weightKg","type":"uint256"},{"internalType":"uint256","name":"heightCm","type":"uint256"},{"internalType":"string[]","name":"allergies","type":"string[]"},{"internalType":"string[]","name":"chronicDiseases","type":"string[]"},{"internalType":"address[]","name":"allowedDoctors","type":"address[]"}],"internalType":"struct LifeHealthChain.PatientProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getFixedProfile","outputs":[{"internalType":"uint256","name":"dateOfBirth","type":"uint256"},{"internalType":"string","name":"gender","type":"string"},{"internalType":"string","name":"bloodGroup","type":"string"}],"stateMutability":"view","type":"function"}
    ];

    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let chartInstance = null;

    let fixedProfileSetupStep = -1;
    let updatableProfileSetupStep = -1;
    let recordSetupStep = -1;

    let profileData = {};
    let recordData = {};

    function addMessage(text, isUser = false) {
      const chatBody = document.getElementById("chat-body");
      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${isUser ? "user" : "bot"}`;
      msgDiv.innerText = text;
      chatBody.appendChild(msgDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function connectWallet() {
      const status = document.getElementById("status");
      status.innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

      if (!window.ethereum) {
        status.innerText = "‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø";
        addMessage("MetaMask ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        if (Number(network.chainId) !== 5042002) {
          status.innerText = "Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶® (Chain ID: 5042002)";
          addMessage("Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá‡•§");
          return;
        }

        contract = new ethers.Contract(contractAddress, abi, signer);
        status.innerText = `‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;

        addMessage("‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶è‡¶ñ‡¶® ‡¶¨‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®:\n‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø\n‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°");

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("userInput").disabled = false;

        try {
          const fixed = await contract.getFixedProfile(userAddress);
          if (fixed.dateOfBirth !== 0n) {
            const profile = await contract.getPatientProfile(userAddress);
            if (profile.weightKg > 0n && profile.heightCm > 0n) {
              addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶õ‡ßá‡•§ ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
            } else {
              updatableProfileSetupStep = 0;
              askForUpdatableProfile();
            }
          } else {
            fixedProfileSetupStep = 0;
            askForFixedProfile();
          }
        } catch (err) {
          fixedProfileSetupStep = 0;
          askForFixedProfile();
        }
      } catch (err) {
        status.innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message;
        addMessage("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message);
      }
    }

    function disconnectWallet() {
      provider = signer = contract = userAddress = null;
      fixedProfileSetupStep = updatableProfileSetupStep = recordSetupStep = -1;
      profileData = recordData = {};
      document.getElementById("status").innerText = "Status: Disconnected";
      document.getElementById("connectBtn").style.display = "block";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("sendBtn").disabled = true;
      document.getElementById("userInput").disabled = true;
      addMessage("‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
      if (chartInstance) chartInstance.destroy();
    }

    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("logoutBtn").onclick = disconnectWallet;

    function askForFixedProfile() {
      const steps = [
        "‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (DD-MM-YYYY)",
        "‡¶≤‡¶ø‡¶ô‡ßç‡¶ó ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (Male/Female/Other)",
        "‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® A+, O-)"
      ];
      addMessage(steps[fixedProfileSetupStep]);
    }

    function askForUpdatableProfile() {
      const steps = [
        "‡¶ì‡¶ú‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (kg)",
        "‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (cm)",
        "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ú‡¶ø (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)",
        "‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡ßü‡¶æ‡¶¶‡¶ø ‡¶∞‡ßã‡¶ó (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)"
      ];
      addMessage(steps[updatableProfileSetupStep]);
    }

    function askForRecord() {
      const steps = [
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® Diabetes)",
        "‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® 180 mg/dL)",
        "‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip)",
        "‡¶°‡ßã‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® 500mg, skip)",
        "‡¶´‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶® 3 times/day, skip)",
        "‡¶ï‡¶§‡¶¶‡¶ø‡¶® ‡¶ñ‡¶æ‡¶¨‡ßá‡¶® (‡¶¶‡¶ø‡¶®, skip)",
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶®‡ßã‡¶ü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤, skip)",
        "IPFS CID (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤, skip)"
      ];
      addMessage(steps[recordSetupStep]);
    }

    document.getElementById("sendBtn").onclick = async () => {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, true);
      input.value = "";

      if (!contract) {
        addMessage("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      const lower = text.toLowerCase().trim();
      const isSkip = lower === "skip" || lower === "‡¶®‡¶æ‡¶á" || lower === "none" || lower === "";

      // Fixed profile mode
      if (fixedProfileSetupStep >= 0) {
        if (isSkip) {
          addMessage("‡¶è‡¶á ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§");
          return;
        }
        switch (fixedProfileSetupStep) {
          case 0:
            const [dd, mm, yyyy] = text.split("-").map(Number);
            if (!dd || !mm || !yyyy || dd < 1 || dd > 31 || mm < 1 || mm > 12) {
              addMessage("‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®: DD-MM-YYYY");
              return;
            }
            const date = new Date(yyyy, mm - 1, dd);
            profileData.dateOfBirth = Math.floor(date.getTime() / 1000);
            break;
          case 1: profileData.gender = text.trim(); break;
          case 2: profileData.bloodGroup = text.trim(); break;
        }
        fixedProfileSetupStep++;
        if (fixedProfileSetupStep === 3) {
          try {
            const tx = await contract.setFixedProfile(
              profileData.dateOfBirth,
              profileData.gender,
              profileData.bloodGroup
            );
            addMessage(`‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá... ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            addMessage("‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            fixedProfileSetupStep = -1;
            updatableProfileSetupStep = 0;
            askForUpdatableProfile();
          } catch (err) {
            addMessage("‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown"));
            fixedProfileSetupStep = -1;
          }
        } else {
          askForFixedProfile();
        }
        return;
      }

      // Updatable profile mode
      if (updatableProfileSetupStep >= 0) {
        switch (updatableProfileSetupStep) {
          case 0: profileData.weightKg = parseInt(text) || 0; break;
          case 1: profileData.heightCm = parseInt(text) || 0; break;
          case 2: profileData.allergies = isSkip ? [] : text.split(",").map(s => s.trim()).filter(Boolean); break;
          case 3: profileData.chronicDiseases = isSkip ? [] : text.split(",").map(s => s.trim()).filter(Boolean); break;
        }
        updatableProfileSetupStep++;
        if (updatableProfileSetupStep === 4) {
          try {
            const tx = await contract.updateProfile(
              profileData.weightKg,
              profileData.heightCm,
              profileData.allergies || [],
              profileData.chronicDiseases || []
            );
            addMessage(`‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            updatableProfileSetupStep = -1;
          } catch (err) {
            addMessage("‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown"));
            updatableProfileSetupStep = -1;
          }
        } else {
          askForUpdatableProfile();
        }
        return;
      }

      // Record mode
      if (recordSetupStep >= 0) {
        if (recordSetupStep < 2 && isSkip) {
          addMessage("‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§");
          return;
        }

        switch (recordSetupStep) {
          case 0: recordData.diseaseName    = text.trim(); break;
          case 1: recordData.readingValue   = text.trim(); break;
          case 2: recordData.medName        = text.trim(); break;
          case 3: recordData.dose           = text.trim(); break;
          case 4: recordData.frequency      = text.trim(); break;
          case 5: recordData.durationDays   = isSkip ? 0 : (parseInt(text) || 0); break;
          case 6: recordData.diseaseDetails = isSkip ? "" : text.trim(); break;
          case 7: recordData.ipfsCid        = isSkip ? "" : text.trim(); break;
        }

        recordSetupStep++;

        if (recordSetupStep === 8) {
          try {
            let medicines = [];

            const medNameClean = (recordData.medName || "").trim();
            const hasValidMed = medNameClean !== "" && !["skip", "‡¶®‡¶æ‡¶á", "none", ""].includes(medNameClean.toLowerCase());

            if (hasValidMed) {
              medicines = [{
                name: medNameClean,
                dose: (recordData.dose || "").trim() || "",
                frequency: (recordData.frequency || "").trim() || "",
                durationDays: recordData.durationDays || 0
              }];
            }

            console.log("===== addDailyRecord DEBUG =====");
            console.log("diseaseName:", recordData.diseaseName || "(empty)");
            console.log("readingValue:", recordData.readingValue || "(empty)");
            console.log("medicines:", medicines);
            console.log("medicines count:", medicines.length);
            console.log("ipfsCid:", recordData.ipfsCid || "(empty)");
            console.log("diseaseDetails:", recordData.diseaseDetails || "(empty)");
            console.log("==============================");

            // ethers.Interface ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá encode ‡¶ï‡¶∞‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
            const iface = new ethers.Interface(abi);
            const encodedData = iface.encodeFunctionData("addDailyRecord", [
              recordData.diseaseName    || "",
              recordData.readingValue   || "",
              medicines,
              recordData.ipfsCid        || "",
              recordData.diseaseDetails || ""
            ]);

            console.log("Encoded calldata (first 100 chars):", encodedData.slice(0, 100) + "...");

            const txRequest = {
              to: contractAddress,
              data: encodedData
            };

            // estimateGas ‡¶ö‡ßá‡¶ï
            try {
              const gasEstimate = await provider.estimateGas(txRequest);
              console.log("Gas estimate success:", gasEstimate.toString());
            } catch (gasErr) {
              console.log("estimateGas failed:", gasErr);
              throw new Error("estimateGas failed: " + (gasErr.message || "Unknown"));
            }

            const tx = await signer.sendTransaction(txRequest);
            addMessage(`‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait(1);
            addMessage("‡¶∏‡¶´‡¶≤! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ '‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì' ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");

            recordSetupStep = -1;
            recordData = {};
          } catch (err) {
            console.error("addDailyRecord ERROR:", err);
            let msg = "‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:\n" + (err.reason || err.message || "Unknown error");
            if (err.data) msg += "\nRevert data: " + JSON.stringify(err.data, null, 2);
            addMessage(msg);
            recordSetupStep = -1;
            recordData = {};
          }
        } else {
          askForRecord();
        }
        return;
      }

      // Normal commands
      if (lower.includes("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì") || lower.includes("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø") || lower.includes("history")) {
        try {
          const records = await contract.getAllDiseaseRecords(userAddress);
          let reply = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶∏‡¶Æ‡ßÇ‡¶π:\n\n";

          if (records.length === 0) {
            reply += "‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§ '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã' ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
          } else {
            records.forEach((disease, i) => {
              reply += `‡¶∞‡ßã‡¶ó #${i+1}: ${disease.diseaseName}\n`;
              disease.dailyRecords.forEach(rec => {
                const date = new Date(Number(rec.timestamp) * 1000).toLocaleString("bn-BD");
                reply += `  ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${date}\n`;
                reply += `  ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç: ${rec.readingValue}\n`;
                reply += `  ‡¶¨‡ßü‡¶∏ (‡¶§‡¶ñ‡¶®): ${rec.patientAgeAtRecord} ‡¶¨‡¶õ‡¶∞\n`;
                reply += `  ‡¶ì‡¶ú‡¶®: ${rec.patientWeightKg} kg | ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ: ${rec.patientHeightCm} cm\n`;
                if (rec.medicines?.length > 0) {
                  reply += "  ‡¶ì‡¶∑‡ßÅ‡¶ß:\n";
                  rec.medicines.forEach(m => {
                    reply += `    ‚Ä¢ ${m.name} (${m.dose || 'N/A'}, ${m.frequency || 'N/A'}, ${m.durationDays} ‡¶¶‡¶ø‡¶®)\n`;
                  });
                }
                if (rec.diseaseDetails) reply += `  ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§: ${rec.diseaseDetails}\n`;
                reply += "\n";
              });
            });
          }
          addMessage(reply);
          updateChart(records);
        } catch (err) {
          addMessage("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.message || "Unknown"));
        }
      }
      else if (lower.includes("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°") || lower.includes("add") || lower.includes("‡¶Ø‡ßã‡¶ó") || lower.includes("‡¶®‡¶§‡ßÅ‡¶®")) {
        recordSetupStep = 0;
        recordData = {};
        addMessage("‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶õ‡¶ø‡•§");
        askForRecord();
      }
      else if (lower.includes("‡¶π‡¶æ‡¶á") || lower.includes("‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã") || lower.includes("hello")) {
        addMessage("‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üòä ‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßá‡¶®? ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶¨‡ßá‡¶®, ‡¶®‡¶æ‡¶ï‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?");
      }
      else {
        addMessage("‡¶Ü‡¶Æ‡¶ø ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø‡•§ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:\n‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì\n‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°\n‚Ä¢ ‡¶π‡¶æ‡¶á / ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã");
      }
    };

    function updateChart(records) {
      const ctx = document.getElementById("recordChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      if (records.length === 0) {
        document.getElementById("recordChart").style.display = "none";
        return;
      }

      document.getElementById("recordChart").style.display = "block";

      let labels = [];
      let data = [];

      records.forEach(disease => {
        disease.dailyRecords.forEach(rec => {
          const dateStr = new Date(Number(rec.timestamp) * 1000).toLocaleDateString("bn-BD");
          labels.push(`${disease.diseaseName} - ${dateStr}`);
          const numValue = parseFloat(rec.readingValue.replace(/[^0-9.]/g, '')) || 0;
          data.push(numValue);
        });
      });

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶Æ‡¶æ‡¶®',
            data: data,
            borderColor: '#009688',
            backgroundColor: 'rgba(0, 150, 136, 0.2)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: true, text: '‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°' }
          },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  </script>
</body>
</html>
