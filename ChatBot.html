<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ - ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #009688;
      --primary-dark: #00796b;
      --accent: #ff5722;
      --bg-gradient: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      --card-bg: white;
      --text-dark: #004d40;
      --text-light: #333;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-light);
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: var(--primary-dark);
      margin: 0 0 20px;
      font-size: 2.2rem;
    }

    #chat-container {
      max-width: 760px;
      margin: 0 auto 30px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      overflow: hidden;
    }

    #chat-header {
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 18px;
      text-align: center;
      font-weight: 600;
      font-size: 1.35rem;
    }

    #chat-body {
      height: 460px;
      overflow-y: auto;
      padding: 24px;
      background: #f8f9fa;
    }

    .message {
      margin: 16px 0;
      padding: 14px 20px;
      border-radius: 22px;
      max-width: 84%;
      line-height: 1.55;
      word-wrap: break-word;
      font-size: 1.02rem;
    }

    .user {
      background: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 6px;
    }

    .bot {
      background: #e0f2f1;
      color: var(--text-dark);
      margin-right: auto;
      border-bottom-left-radius: 6px;
    }

    #input-area {
      display: flex;
      padding: 16px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
    }

    #userInput {
      flex: 1;
      padding: 14px 20px;
      border: 1px solid #ccc;
      border-radius: 50px;
      outline: none;
      font-size: 1.05rem;
      transition: border-color 0.2s;
    }

    #userInput:focus {
      border-color: var(--primary);
    }

    #sendBtn {
      margin-left: 12px;
      padding: 0 28px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    #sendBtn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .auth-buttons {
      text-align: center;
      margin: 24px 0;
    }

    #connectBtn, #logoutBtn {
      padding: 14px 40px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.2s;
      margin: 0 10px;
    }

    #connectBtn {
      background: var(--accent);
      color: white;
    }

    #connectBtn:hover {
      background: #e64a19;
    }

    #logoutBtn {
      background: #e74c3c;
      color: white;
      display: none;
    }

    #logoutBtn:hover {
      background: #c0392b;
    }

    #status {
      text-align: center;
      margin: 16px 0;
      color: #555;
      font-weight: 500;
    }

    canvas {
      margin: 30px auto;
      display: block;
      max-width: 100%;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    #pieChart {
      margin-top: 40px !important;
    }

    @media (max-width: 600px) {
      body { padding: 12px; }
      #chat-body { height: 380px; }
      h1 { font-size: 1.8rem; }
    }
  </style>
</head>
<body>

  <h1>AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ - ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü</h1>

  <div id="chat-container">
    <div id="chat-header">Arc Testnet - LifeHealth Chain</div>
    <div id="chat-body">
      <div class="message bot">
        ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üëã ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡•§<br><br>
        ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶‡ßá ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶¨‡•§<br>
        ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßã, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶¨‡•§<br><br>
        ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ø‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã:<br>
        ‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br>
        ‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã
      </div>
    </div>

    <div id="input-area">
      <input type="text" id="userInput" placeholder="‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶¨‡¶≤‡ßã ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì..." autocomplete="off" />
      <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
    </div>
  </div>

  <div class="auth-buttons">
    <button id="connectBtn">‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (Arc Testnet)</button>
    <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
  </div>

  <div id="status">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶®‡¶Ø‡¶º</div>

  <!-- ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ø‡¶´‡¶ø‡¶ï ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶´‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø -->
  <canvas id="recordChart" width="600" height="300" style="display: none;"></canvas>

  <!-- ‡¶∏‡¶¨ ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶™‡¶æ‡¶á ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü -->
  <canvas id="pieChart" width="600" height="400" style="display: none;"></canvas>

  <script>
    const CONTRACT_ADDRESS = "0x1cA1699c69852Eb81D4eb68Da33ac61D064f7Be1";
    const ARC_TESTNET_CHAIN_ID = 5042002;

    const ABI = [
      {"inputs":[{"internalType":"uint256","name":"_dateOfBirth","type":"uint256"},{"internalType":"string","name":"_gender","type":"string"},{"internalType":"string","name":"_bloodGroup","type":"string"}],"name":"setFixedProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"_weightKg","type":"uint256"},{"internalType":"uint256","name":"_heightCm","type":"uint256"},{"internalType":"string[]","name":"_allergies","type":"string[]"},{"internalType":"string[]","name":"_chronicDiseases","type":"string[]"}],"name":"updateProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"_diseaseName","type":"string"},{"internalType":"string","name":"_readingValue","type":"string"},{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"dose","type":"string"},{"internalType":"string","name":"frequency","type":"string"},{"internalType":"uint256","name":"durationDays","type":"uint256"}],"internalType":"struct LifeHealthChain.Medicine[]","name":"_medicines","type":"tuple[]"},{"internalType":"string","name":"_ipfsCid","type":"string"},{"internalType":"string","name":"_diseaseDetails","type":"string"}],"name":"addDailyRecord","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getAllDiseaseRecords","outputs":[{"components":[{"internalType":"string","name":"diseaseName","type":"string"},{"components":[{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"string","name":"readingValue","type":"string"},{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"dose","type":"string"},{"internalType":"string","name":"frequency","type":"string"},{"internalType":"uint256","name":"durationDays","type":"uint256"}],"internalType":"struct LifeHealthChain.Medicine[]","name":"medicines","type":"tuple[]"},{"internalType":"string","name":"ipfsCid","type":"string"},{"internalType":"address","name":"addedBy","type":"address"},{"internalType":"uint256","name":"patientAgeAtRecord","type":"uint256"},{"internalType":"uint256","name":"patientWeightKg","type":"uint256"},{"internalType":"uint256","name":"patientHeightCm","type":"uint256"}],"internalType":"struct LifeHealthChain.DailyRecord[]","name":"dailyRecords","type":"tuple[]"}],"internalType":"struct LifeHealthChain.DiseaseRecord[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getPatientProfile","outputs":[{"components":[{"internalType":"uint256","name":"weightKg","type":"uint256"},{"internalType":"uint256","name":"heightCm","type":"uint256"},{"internalType":"string[]","name":"allergies","type":"string[]"},{"internalType":"string[]","name":"chronicDiseases","type":"string[]"},{"internalType":"address[]","name":"allowedDoctors","type":"address[]"}],"internalType":"struct LifeHealthChain.PatientProfile","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"patient","type":"address"}],"name":"getFixedProfile","outputs":[{"internalType":"uint256","name":"dateOfBirth","type":"uint256"},{"internalType":"string","name":"gender","type":"string"},{"internalType":"string","name":"bloodGroup","type":"string"}],"stateMutability":"view","type":"function"}
    ];

    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let lineChartInstance = null;
    let pieChartInstance = null;

    let fixedProfileStep = -1;
    let updatableProfileStep = -1;
    let recordStep = -1;
    let waitingForDiseaseGraph = false;
    let allDiseases = [];

    let profileData = {};
    let recordData = {};

    function addMessage(text, isUser = false) {
      const chatBody = document.getElementById("chat-body");
      const msgDiv = document.createElement("div");
      msgDiv.className = `message ${isUser ? "user" : "bot"}`;
      msgDiv.innerHTML = text;
      chatBody.appendChild(msgDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      document.getElementById("userInput").focus();
    }

    function updateStatus(text) {
      document.getElementById("status").textContent = `‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ${text}`;
    }

    async function connectWallet() {
      if (!window.ethereum) {
        updateStatus("‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø");
        addMessage("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá MetaMask ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø Ethereum ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      try {
        updateStatus("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        if (Number(network.chainId) !== ARC_TESTNET_CHAIN_ID) {
          updateStatus("Arc Testnet-‡¶è ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶® (Chain ID: 5042002)");
          addMessage("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá MetaMask-‡¶è Arc Testnet ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï‡ßá ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
          return;
        }

        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        updateStatus(`‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`);
        addMessage("‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®:<br>‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì / ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø<br>‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã / ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°");

        document.getElementById("connectBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("userInput").disabled = false;

        await checkProfiles();
      } catch (err) {
        updateStatus("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ");
        addMessage("‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown error"));
      }
    }

    function disconnectWallet() {
      provider = signer = contract = userAddress = null;
      fixedProfileStep = updatableProfileStep = recordStep = -1;
      waitingForDiseaseGraph = false;
      allDiseases = [];
      updateStatus("‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶®‡¶Ø‡¶º");
      document.getElementById("connectBtn").style.display = "inline-block";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("sendBtn").disabled = true;
      document.getElementById("userInput").disabled = true;
      addMessage("‡¶Ü‡¶™‡¶®‡¶ø ‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");

      if (lineChartInstance) {
        lineChartInstance.destroy();
        lineChartInstance = null;
      }
      if (pieChartInstance) {
        pieChartInstance.destroy();
        pieChartInstance = null;
      }
    }

    async function checkProfiles() {
      try {
        const fixed = await contract.getFixedProfile(userAddress);
        if (fixed.dateOfBirth !== 0n) {
          addMessage("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§");
          fixedProfileStep = -1;
          const profile = await contract.getPatientProfile(userAddress);
          if (profile.weightKg > 0n && profile.heightCm > 0n) {
            addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡ßá‡¶ü‡•§ ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
          } else {
            addMessage("‡¶ì‡¶ú‡¶®, ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶ö‡¶≤‡ßÅ‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø‡•§");
            updatableProfileStep = 0;
            askUpdatableProfile();
          }
        } else {
          addMessage("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá (‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ, ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó, ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™)‡•§");
          fixedProfileStep = 0;
          askFixedProfile();
        }
      } catch (err) {
        addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶ö‡¶≤‡ßÅ‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶ø‡•§");
        fixedProfileStep = 0;
        askFixedProfile();
      }
    }

    function askFixedProfile() {
      const questions = [
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (DD-MM-YYYY ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ó ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (Male / Female / Other)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: A+, O-, B- ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø)"
      ];
      addMessage(questions[fixedProfileStep]);
      document.getElementById("userInput").focus();
    }

    function askUpdatableProfile() {
      const questions = [
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ì‡¶ú‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡ßá‡¶ú‡¶ø‡¶§‡ßá)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá)",
        "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡ßç‡¶ú‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)",
        "‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡¶ø ‡¶∞‡ßã‡¶ó ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá skip ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)"
      ];
      addMessage(questions[updatableProfileStep]);
      document.getElementById("userInput").focus();
    }

    function askRecord() {
      const questions = [
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶°‡¶æ‡¶Ø‡¶º‡¶æ‡¶¨‡ßá‡¶ü‡¶ø‡¶∏, ‡¶â‡¶ö‡ßç‡¶ö ‡¶∞‡¶ï‡ßç‡¶§‡¶ö‡¶æ‡¶™)",
        "‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç / ‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 180 mg/dL)",
        "‡¶ì‡¶∑‡ßÅ‡¶ß‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶æ‡¶π‡¶≤‡ßá skip ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)",
        "‡¶°‡ßã‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 500mg, skip ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)",
        "‡¶ï‡¶§‡¶¨‡¶æ‡¶∞ ‡¶ñ‡¶æ‡¶¨‡ßá‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¶‡¶ø‡¶®‡ßá ‡ß® ‡¶¨‡¶æ‡¶∞, skip ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)",
        "‡¶ï‡¶§‡¶¶‡¶ø‡¶® ‡¶ñ‡¶æ‡¶¨‡ßá‡¶® (‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ, skip ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)",
        "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ / ‡¶®‡ßã‡¶ü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤, skip ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)",
        "IPFS CID (‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßá‡¶®, ‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)"
      ];
      addMessage(questions[recordStep]);
      document.getElementById("userInput").focus();
    }

    async function getAIAdvice(records) {
      if (records.length === 0) return;

      try {
        addMessage("AI ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶ï‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ö‡ßç‡¶õ‡¶ø... ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßã‡•§");

        const serializableRecords = records.map(r => ({
          diseaseName: r.diseaseName,
          dailyRecords: r.dailyRecords.map(dr => ({
            timestamp: dr.timestamp.toString(),
            readingValue: dr.readingValue,
            medicines: dr.medicines.map(m => ({
              name: m.name,
              dose: m.dose,
              frequency: m.frequency,
              durationDays: m.durationDays.toString()
            })),
            ipfsCid: dr.ipfsCid,
            addedBy: dr.addedBy,
            patientAgeAtRecord: dr.patientAgeAtRecord.toString(),
            patientWeightKg: dr.patientWeightKg.toString(),
            patientHeightCm: dr.patientHeightCm.toString(),
            diseaseDetails: dr.diseaseDetails
          }))
        }));

        const response = await fetch('https://ai-doctor-blockchain.vercel.app/api', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            records: serializableRecords,
            userMessage: "‡¶è‡¶á ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶π‡¶ú ‡¶ì ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶¶‡¶æ‡¶ì‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶Ø‡¶º‡¶∏/‡¶≤‡¶ø‡¶ô‡ßç‡¶ó/‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡¶æ ‡¶ú‡¶æ‡¶®‡¶≤‡ßá ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ü‡¶ø‡¶™‡¶∏ ‡¶¶‡¶ø‡¶ì‡•§ ‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡¶∑‡ßÅ‡¶ß ‡¶¨‡¶æ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶® ‡¶¶‡ßá‡¶¨‡ßá ‡¶®‡¶æ‡•§"
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        if (data.advice && data.advice.trim()) {
          addMessage("AI ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂:\n\n" + data.advice);
        } else {
          addMessage("AI ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
        }
      } catch (err) {
        console.error("AI fetch error:", err);
        addMessage("AI ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.message || "Unknown error"));
      }
    }

    document.getElementById("sendBtn").onclick = async () => {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, true);
      input.value = "";

      if (!signer) {
        addMessage("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ì‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
      }

      const lower = text.toLowerCase();

      // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤
      if (fixedProfileStep >= 0) {
        if (["skip","‡¶®‡¶æ‡¶á",""].includes(low)) {
          addMessage("‡¶è‡¶á ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§");
          return;
        }

        switch (fixedProfileStep) {
          case 0:
            const [d, m, y] = text.split("-").map(Number);
            if (!d || !m || !y || isNaN(d)) return addMessage("‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: DD-MM-YYYY");
            const dateObj = new Date(y, m-1, d);
            profileData.dateOfBirth = Math.floor(dateObj.getTime() / 1000);
            break;
          case 1: profileData.gender = text.trim(); break;
          case 2: profileData.bloodGroup = text.trim(); break;
        }

        fixedProfileStep++;
        if (fixedProfileStep === 3) {
          try {
            const tx = await contract.setFixedProfile(
              profileData.dateOfBirth,
              profileData.gender,
              profileData.bloodGroup
            );
            addMessage(`‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            addMessage("‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            fixedProfileStep = -1;
            await checkProfiles();
          } catch (err) {
            addMessage("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown error"));
            fixedProfileStep = -1;
            await checkProfiles();
          }
        } else {
          askFixedProfile();
        }
        return;
      }

      // ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶¨‡¶≤ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤
      if (updatableProfileStep >= 0) {
        const skipped = ["skip", "‡¶®‡¶æ‡¶á", ""].includes(lower);
        if (skipped && updatableProfileStep < 2) {
          addMessage("‡¶ì‡¶ú‡¶® ‡¶ì ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§");
          return;
        }

        switch (updatableProfileStep) {
          case 0: profileData.weightKg = parseInt(text) || 0; break;
          case 1: profileData.heightCm = parseInt(text) || 0; break;
          case 2: profileData.allergies = skipped ? [] : text.split(",").map(s => s.trim()).filter(Boolean); break;
          case 3: profileData.chronicDiseases = skipped ? [] : text.split(",").map(s => s.trim()).filter(Boolean); break;
        }

        updatableProfileStep++;
        if (updatableProfileStep === 4) {
          try {
            const tx = await contract.updateProfile(
              profileData.weightKg,
              profileData.heightCm,
              profileData.allergies || [],
              profileData.chronicDiseases || []
            );
            addMessage(`‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            addMessage("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§");
            updatableProfileStep = -1;
          } catch (err) {
            addMessage("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown error"));
            updatableProfileStep = -1;
          }
        } else {
          askUpdatableProfile();
        }
        return;
      }

      // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°
      if (recordStep >= 0) {
        const skipped = ["skip", "‡¶®‡¶æ‡¶á", ""].includes(lower);

        switch (recordStep) {
          case 0: recordData.diseaseName    = text.trim() || ""; break;
          case 1: recordData.readingValue   = text.trim() || ""; break;
          case 2: recordData.medicineName   = skipped ? "" : text.trim(); break;
          case 3: recordData.dose           = skipped ? "" : text.trim(); break;
          case 4: recordData.frequency      = skipped ? "" : text.trim(); break;
          case 5: recordData.durationDays   = skipped ? 0 : (parseInt(text) || 0); break;
          case 6: recordData.diseaseDetails = skipped ? "" : text.trim(); break;
          case 7: recordData.ipfsCid        = skipped ? "" : text.trim(); break;
        }

        recordStep++;

        if (recordStep === 8) {
          try {
            const functionSelector = "0xcaf5bb2c";
            const coder = new ethers.AbiCoder();

            const medicines = [];
            if (recordData.medicineName && recordData.medicineName.trim() !== "" && recordData.medicineName.toLowerCase() !== "skip") {
              medicines.push([
                recordData.medicineName.trim(),
                recordData.dose || "",
                recordData.frequency || "",
                BigInt(recordData.durationDays || 0)
              ]);
            }

            const encodedParams = coder.encode(
              ["string", "string", "tuple(string,string,string,uint256)[]", "string", "string"],
              [
                recordData.diseaseName || "",
                recordData.readingValue || "",
                medicines,
                recordData.ipfsCid || "",
                recordData.diseaseDetails || ""
              ]
            );

            const fullCalldata = functionSelector + encodedParams.slice(2);

            const tx = await signer.sendTransaction({
              to: CONTRACT_ADDRESS,
              data: fullCalldata
            });

            addMessage(`‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... Tx: ${tx.hash.slice(0,10)}...`);
            await tx.wait();
            addMessage("‡¶∏‡¶´‡¶≤! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ '‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì' ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
            recordStep = -1;
          } catch (err) {
            console.error("Record add error:", err);
            addMessage("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.reason || err.message || "Unknown error"));
            recordStep = -1;
          }
        } else {
          askRecord();
        }
        return;
      }

      // ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì + AI ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ + ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶´ ‡¶ö‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
      if (lower.includes("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì") || lower.includes("‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø") || lower.includes("record") || lower.includes("history")) {
        try {
          const records = await contract.getAllDiseaseRecords(userAddress);
          let reply = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶∏‡¶Æ‡ßÇ‡¶π:\n\n";

          if (records.length === 0) {
            reply += "‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§";
          } else {
            allDiseases = [...new Set(records.map(r => r.diseaseName.trim()))];

            reply += "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßã‡¶ó‡¶ó‡ßÅ‡¶≤‡ßã: " + allDiseases.join(", ") + "\n\n";

            records.forEach(disease => {
              reply += `‡¶∞‡ßã‡¶ó: ${disease.diseaseName}\n`;
              disease.dailyRecords.forEach(r => {
                const date = new Date(Number(r.timestamp) * 1000).toLocaleString("bn-BD");
                reply += ` ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${date}\n`;
                reply += ` ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç: ${r.readingValue}\n`;
                reply += ` ‡¶¨‡¶Ø‡¶º‡¶∏: ${r.patientAgeAtRecord} ‡¶¨‡¶õ‡¶∞\n`;
                reply += ` ‡¶ì‡¶ú‡¶®: ${r.patientWeightKg} kg   ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ: ${r.patientHeightCm} cm\n`;

                if (r.medicines.length > 0) {
                  reply += " ‡¶ì‡¶∑‡ßÅ‡¶ß:\n";
                  r.medicines.forEach(m => {
                    reply += ` ‚Ä¢ ${m.name} (${m.dose}, ${m.frequency}, ${m.durationDays} ‡¶¶‡¶ø‡¶®)\n`;
                  });
                }

                if (r.diseaseDetails) reply += ` ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§: ${r.diseaseDetails}\n`;
                reply += "\n";
              });
            });
          }

          addMessage(reply);

          // ‡¶™‡¶æ‡¶á ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
          updateChart(records);

          // AI ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂
          if (records.length > 0) {
            await getAIAdvice(records);
          }

          // ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶´ ‡¶ö‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
          if (records.length > 0 && allDiseases.length > 0) {
            addMessage(
              `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßã‡¶ó‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ï‡ßã‡¶®‡¶ü‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶´ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?<br>` +
              `‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: <b>${allDiseases.join("</b>, <b>")}</b><br>` +
              `‡¶è‡¶ï‡¶ü‡¶æ ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§<br>` +
              `(‡¶ó‡ßç‡¶∞‡¶æ‡¶´ ‡¶®‡¶æ ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶ö‡ßÅ‡¶™ ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®)`
            );
            waitingForDiseaseGraph = true;
          }

        } catch (err) {
          addMessage("‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + (err.message || "Unknown error"));
        }
        return;
      }

      // ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ø‡¶´‡¶ø‡¶ï ‡¶≤‡¶æ‡¶á‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶´ ‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßã
      if (waitingForDiseaseGraph) {
        const requestedDisease = text.trim().toLowerCase();

        if (allDiseases.some(d => d.toLowerCase() === requestedDisease)) {
          try {
            const records = await contract.getAllDiseaseRecords(userAddress);

            const filtered = records.filter(r => r.diseaseName.toLowerCase() === requestedDisease);

            if (filtered.length === 0) {
              addMessage(`"${text}" ‡¶è‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§`);
            } else {
              const labels = [];
              const data = [];

              filtered.forEach(disease => {
                disease.dailyRecords.forEach(r => {
                  const date = new Date(Number(r.timestamp) * 1000).toLocaleDateString("bn-BD");
                  labels.push(date);
                  const val = parseFloat(r.readingValue?.split(" ")[0]) || 0;
                  data.push(val);
                });
              });

              const lineCanvas = document.getElementById("recordChart");
              if (!lineCanvas) {
                addMessage("‡¶ó‡ßç‡¶∞‡¶æ‡¶´ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø canvas ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                return;
              }

              const ctx = lineCanvas.getContext("2d");
              if (lineChartInstance) lineChartInstance.destroy();

              lineCanvas.style.display = "block";

              lineChartInstance = new Chart(ctx, {
                type: "line",
                data: {
                  labels,
                  datasets: [{
                    label: `${text} ‡¶è‡¶∞ ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç`,
                    data,
                    borderColor: "#e74c3c",
                    backgroundColor: "rgba(231, 76, 60, 0.2)",
                    fill: true,
                    tension: 0.4
                  }]
                },
                options: {
                  responsive: true,
                  plugins: {
                    legend: { display: true },
                    title: { display: true, text: `${text} ‡¶è‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶≤‡¶æ‡¶á‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶´` }
                  },
                  scales: {
                    y: { beginAtZero: true }
                  }
                }
              });

              addMessage(`"${text}" ‡¶è‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶´ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶â‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§`);
            }
          } catch (err) {
            addMessage("‡¶ó‡ßç‡¶∞‡¶æ‡¶´ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + err.message);
          }
        } else {
          addMessage(`"${text}" ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßã‡¶ó ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡ßá ‡¶®‡ßá‡¶á‡•§`);
        }

        waitingForDiseaseGraph = false;
        return;
      }

      if (lower.includes("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°") || lower.includes("add") || lower.includes("‡¶Ø‡ßã‡¶ó") || lower.includes("‡¶®‡¶§‡ßÅ‡¶®")) {
        recordStep = 0;
        recordData = {};
        addMessage("‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá! ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶õ‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
        askRecord();
        return;
      }

      if (["‡¶π‡¶æ‡¶á", "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã", "‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã", "‡¶π‡ßá‡¶≤‡ßã"].some(w => lower.includes(w))) {
        addMessage("‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! üòä ‡¶Ü‡¶Æ‡¶ø ‡¶≠‡¶æ‡¶≤‡ßã ‡¶Ü‡¶õ‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?");
        return;
      }

      addMessage("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶Æ‡¶ø ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø‡•§ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:\n‚Ä¢ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì\n‚Ä¢ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßã\n‚Ä¢ ‡¶π‡¶æ‡¶á / ‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã");
    };

    // ========================================
    //          ‡¶™‡¶æ‡¶á ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶è‡¶ü‡¶æ‡¶á ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã)
    // ========================================
    function updateChart(records) {
      const pieCanvas = document.getElementById("pieChart");
      if (!pieCanvas) {
        console.warn("pieChart canvas ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø");
        return;
      }

      // ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã ‡¶™‡¶æ‡¶á ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶ß‡ßç‡¶¨‡¶Ç‡¶∏ ‡¶ï‡¶∞‡¶æ
      if (window.pieChartInstance) {
        window.pieChartInstance.destroy();
      }

      if (!records || records.length === 0) {
        pieCanvas.style.display = "none";
        return;
      }

      pieCanvas.style.display = "block";

      const diseaseCounts = {};
      records.forEach(disease => {
        const name = disease.diseaseName.trim();
        diseaseCounts[name] = (diseaseCounts[name] || 0) + disease.dailyRecords.length;
      });

      const pieLabels = Object.keys(diseaseCounts);
      const pieData = Object.values(diseaseCounts);

      window.pieChartInstance = new Chart(pieCanvas.getContext("2d"), {
        type: "pie",
        data: {
          labels: pieLabels,
          datasets: [{
            label: "‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ",
            data: pieData,
            backgroundColor: [
              "#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0",
              "#9966FF", "#FF9F40", "#E7E9ED", "#C9CBCF"
            ],
            borderColor: "#fff",
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: { display: true, text: "‡¶∞‡ßã‡¶ó ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£", font: { size: 16 } }
          }
        }
      });
    }

    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("logoutBtn").onclick = disconnectWallet;

    document.getElementById("userInput").addEventListener("keypress", e => {
      if (e.key === "Enter") document.getElementById("sendBtn").click();
    });
  </script>
</body>
</html>
